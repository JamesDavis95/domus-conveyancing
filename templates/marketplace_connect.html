<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace Connect | Domus Platform</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .marketplace-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        
        .connect-status-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-connected { background: #dcfce7; color: #166534; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-incomplete { background: #fee2e2; color: #991b1b; }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .metric-label {
            font-size: 14px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        
        .transactions-table th,
        .transactions-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .transactions-table th {
            background: #f9fafb;
            font-weight: 600;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn-outline {
            background: transparent;
            color: #3b82f6;
            border: 2px solid #3b82f6;
        }
        
        .btn-outline:hover {
            background: #3b82f6;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .onboarding-flow {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .fee-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        
        .transaction-row {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .transaction-row:hover {
            background: #f9fafb;
        }
        
        .role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .role-buyer { background: #dbeafe; color: #1e40af; }
        .role-seller { background: #dcfce7; color: #166534; }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
        
        .success-message {
            background: #dcfce7;
            color: #166534;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="marketplace-container">
        <h1>Marketplace Connect</h1>
        <p>Manage your Stripe Connect account for marketplace transactions and seller payouts</p>
        
        <!-- Connect Status -->
        <div id="connect-status" class="connect-status-card">
            <h2>Connect Account Status</h2>
            <div id="status-content">
                <p>Loading account status...</p>
            </div>
        </div>
        
        <!-- Onboarding Flow -->
        <div id="onboarding-flow" class="onboarding-flow" style="display: none;">
            <h3>🚀 Seller Onboarding Required</h3>
            <p>Complete Stripe Express onboarding to start receiving marketplace payments with automated transfers.</p>
            <div class="fee-info">
                <strong>📊 Application Fee: 7%</strong><br>
                Domus Platform charges a 7% application fee on all marketplace transactions. 
                You receive 93% of each sale automatically transferred to your account.
            </div>
            <button class="btn btn-success" onclick="startOnboarding()">
                Start Seller Onboarding
            </button>
        </div>
        
        <!-- Analytics Dashboard -->
        <div id="analytics-section" style="display: none;">
            <h2>Marketplace Analytics</h2>
            <div class="analytics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="total-sales">0</div>
                    <div class="metric-label">Total Sales</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="total-revenue">£0.00</div>
                    <div class="metric-label">Total Revenue</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="total-fees">£0.00</div>
                    <div class="metric-label">Fees Paid</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="total-purchases">0</div>
                    <div class="metric-label">Total Purchases</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="total-spent">£0.00</div>
                    <div class="metric-label">Total Spent</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avg-transaction">£0.00</div>
                    <div class="metric-label">Avg Transaction</div>
                </div>
            </div>
        </div>
        
        <!-- Recent Transactions -->
        <div id="transactions-section" style="display: none;">
            <h2>Recent Transactions</h2>
            <div id="transactions-list">
                <p>Loading transactions...</p>
            </div>
        </div>
        
        <!-- Connect Account Management -->
        <div id="account-management" style="display: none;">
            <h2>Account Management</h2>
            <div style="margin-top: 16px;">
                <button class="btn btn-outline" onclick="refreshOnboarding()">
                    Refresh Onboarding
                </button>
                <button class="btn" onclick="createInstantPayout()" style="margin-left: 12px;">
                    Request Instant Payout
                </button>
            </div>
        </div>
        
        <!-- Messages -->
        <div id="message-container"></div>
    </div>

    <script>
        // Initialize Stripe
        const stripe = Stripe('{{ stripe_publishable_key }}');
        let connectStatus = null;
        let analytics = null;
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadConnectStatus();
            loadAnalytics();
            loadTransactions();
        });
        
        async function loadConnectStatus() {
            try {
                const response = await fetch('/api/marketplace/connect/status');
                
                if (response.status === 404) {
                    // No Connect account exists
                    showOnboardingFlow();
                    return;
                }
                
                connectStatus = await response.json();
                displayConnectStatus(connectStatus);
                
                if (connectStatus.charges_enabled && connectStatus.payouts_enabled) {
                    document.getElementById('analytics-section').style.display = 'block';
                    document.getElementById('transactions-section').style.display = 'block';
                    document.getElementById('account-management').style.display = 'block';
                } else {
                    showOnboardingFlow();
                }
                
            } catch (error) {
                console.error('Failed to load Connect status:', error);
                showError('Failed to load account status');
            }
        }
        
        function displayConnectStatus(status) {
            const container = document.getElementById('status-content');
            
            let statusBadge = 'status-incomplete';
            let statusText = 'Incomplete';
            
            if (status.charges_enabled && status.payouts_enabled) {
                statusBadge = 'status-connected';
                statusText = 'Connected';
            } else if (status.details_submitted) {
                statusBadge = 'status-pending';
                statusText = 'Pending Verification';
            }
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <p><strong>Account ID:</strong> ${status.account_id}</p>
                        <p><strong>Status:</strong> <span class="status-badge ${statusBadge}">${statusText}</span></p>
                    </div>
                    <div>
                        <p><strong>Charges:</strong> ${status.charges_enabled ? '✅ Enabled' : '❌ Disabled'}</p>
                        <p><strong>Payouts:</strong> ${status.payouts_enabled ? '✅ Enabled' : '❌ Disabled'}</p>
                    </div>
                </div>
            `;
        }
        
        function showOnboardingFlow() {
            document.getElementById('onboarding-flow').style.display = 'block';
        }
        
        async function startOnboarding() {
            try {
                showMessage('Starting onboarding process...', 'info');
                
                const response = await fetch('/api/marketplace/connect/onboard', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        business_type: 'individual',
                        refresh_url: window.location.href,
                        return_url: window.location.href + '?onboarding=success'
                    })
                });
                
                const data = await response.json();
                
                if (data.onboarding_url) {
                    // Redirect to Stripe onboarding
                    window.location.href = data.onboarding_url;
                } else {
                    showError('Failed to start onboarding process');
                }
                
            } catch (error) {
                console.error('Onboarding failed:', error);
                showError('Failed to start onboarding process');
            }
        }
        
        async function refreshOnboarding() {
            try {
                const response = await fetch('/api/marketplace/connect/refresh-onboarding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        refresh_url: window.location.href,
                        return_url: window.location.href + '?onboarding=refresh'
                    })
                });
                
                const data = await response.json();
                
                if (data.onboarding_url) {
                    window.location.href = data.onboarding_url;
                } else {
                    showError('Failed to refresh onboarding link');
                }
                
            } catch (error) {
                console.error('Refresh failed:', error);
                showError('Failed to refresh onboarding link');
            }
        }
        
        async function loadAnalytics() {
            try {
                const response = await fetch('/api/marketplace/analytics');
                analytics = await response.json();
                
                displayAnalytics(analytics);
                
            } catch (error) {
                console.error('Failed to load analytics:', error);
                // Don't show error for analytics as it may not be available for new accounts
            }
        }
        
        function displayAnalytics(data) {
            document.getElementById('total-sales').textContent = data.total_sales || 0;
            document.getElementById('total-revenue').textContent = `£${((data.total_revenue_pence || 0) / 100).toFixed(2)}`;
            document.getElementById('total-fees').textContent = `£${((data.total_fees_paid_pence || 0) / 100).toFixed(2)}`;
            document.getElementById('total-purchases').textContent = data.total_purchases || 0;
            document.getElementById('total-spent').textContent = `£${((data.total_spent_pence || 0) / 100).toFixed(2)}`;
            
            const avgTransaction = data.total_sales > 0 ? (data.total_revenue_pence / data.total_sales) : 0;
            document.getElementById('avg-transaction').textContent = `£${(avgTransaction / 100).toFixed(2)}`;
        }
        
        async function loadTransactions() {
            try {
                const response = await fetch('/api/marketplace/contracts?limit=10');
                const data = await response.json();
                
                displayTransactions(data.contracts);
                
            } catch (error) {
                console.error('Failed to load transactions:', error);
                document.getElementById('transactions-list').innerHTML = 
                    '<p style="color: #6b7280;">No transactions available</p>';
            }
        }
        
        function displayTransactions(transactions) {
            const container = document.getElementById('transactions-list');
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No transactions yet</p>';
                return;
            }
            
            let tableHTML = `
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Fee</th>
                            <th>Counterparty</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Units</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            transactions.forEach(tx => {
                const date = new Date(tx.contract_date).toLocaleDateString();
                const amount = `£${(tx.amount_pence / 100).toFixed(2)}`;
                const fee = `£${(tx.application_fee_pence / 100).toFixed(2)}`;
                const counterparty = tx.is_buyer ? tx.seller_org_name : tx.buyer_org_name;
                const role = tx.is_buyer ? 'Buyer' : 'Seller';
                const roleBadge = tx.is_buyer ? 'role-buyer' : 'role-seller';
                const units = tx.biodiversity_units ? `${tx.biodiversity_units} units` : 'N/A';
                
                tableHTML += `
                    <tr class="transaction-row" onclick="viewTransactionDetails('${tx.contract_id}')">
                        <td>${date}</td>
                        <td>${amount}</td>
                        <td>${fee}</td>
                        <td>${counterparty}</td>
                        <td><span class="role-badge ${roleBadge}">${role}</span></td>
                        <td><span class="status-badge status-${tx.status.toLowerCase()}">${tx.status}</span></td>
                        <td>${units}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }
        
        function viewTransactionDetails(contractId) {
            // TODO: Implement transaction details modal
            console.log('View transaction details:', contractId);
            showMessage(`Transaction details for contract ${contractId}`, 'info');
        }
        
        async function createInstantPayout() {
            if (!connectStatus || !connectStatus.account_id) {
                showError('No Connect account available');
                return;
            }
            
            const amount = prompt('Enter payout amount in pounds (e.g., 100.50):');
            if (!amount) return;
            
            const amountPence = Math.round(parseFloat(amount) * 100);
            if (isNaN(amountPence) || amountPence <= 0) {
                showError('Invalid amount entered');
                return;
            }
            
            try {
                showMessage('Creating instant payout...', 'info');
                
                const response = await fetch('/api/marketplace/payouts/instant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account_id: connectStatus.account_id,
                        amount_pence: amountPence,
                        currency: 'gbp'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(`Instant payout of £${(amountPence / 100).toFixed(2)} created successfully`);
                } else {
                    showError(data.detail || 'Failed to create payout');
                }
                
            } catch (error) {
                console.error('Payout failed:', error);
                showError('Failed to create instant payout');
            }
        }
        
        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            const className = type === 'error' ? 'error-message' : 
                             type === 'success' ? 'success-message' : 'info-message';
            
            container.innerHTML = `<div class="${className}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        function showError(message) {
            showMessage(message, 'error');
        }
        
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        // Handle URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('onboarding') === 'success') {
            showSuccess('Onboarding completed successfully! Your account is being verified.');
            // Remove URL parameter
            window.history.replaceState({}, document.title, window.location.pathname);
            // Reload status
            setTimeout(() => {
                loadConnectStatus();
            }, 2000);
        } else if (urlParams.get('onboarding') === 'refresh') {
            showMessage('Onboarding link refreshed', 'info');
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
</body>
</html>