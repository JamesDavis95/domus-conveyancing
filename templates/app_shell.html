<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title | default("Domus Planning Platform") }}</title>
    <link rel="stylesheet" href="/static/dashboard.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --surface: #f8fafc;
            --surface-dark: #f1f5f9;
            --text: #1e293b;
            --text-light: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--surface);
            color: var(--text);
            line-height: 1.6;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: var(--white);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow);
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }
        
        .logo-subtitle {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }
        
        /* Navigation Styles */
        .nav-section {
            padding: 0 20px;
            margin: 16px 0;
        }
        
        .nav-item {
            display: block;
            padding: 12px 16px;
            margin: 4px 0;
            color: var(--text);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .nav-item:hover {
            background: var(--surface);
            color: var(--primary);
        }
        
        .nav-item.active {
            background: var(--primary);
            color: var(--white);
        }
        
        .nav-item-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .nav-item-text {
            display: inline-block;
            vertical-align: middle;
        }
        
        .nav-submenu {
            margin-left: 32px;
            margin-top: 8px;
        }
        
        .nav-submenu .nav-item {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 8px;
            padding: 0 16px;
        }
        
        /* Main Content Styles */
        .main-content {
            margin-left: 260px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* Topbar Styles */
        .topbar {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 999;
        }
        
        .topbar-left {
            flex: 1;
        }
        
        .topbar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .breadcrumb {
            color: var(--text-light);
            font-size: 14px;
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin-top: 4px;
        }
        
        /* Usage Bar Component */
        .usage-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--surface);
            border-radius: 8px;
            font-size: 13px;
        }
        
        .usage-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .usage-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .usage-dot.good { background: var(--success); }
        .usage-dot.warning { background: var(--warning); }
        .usage-dot.danger { background: var(--danger); }
        
        /* Notifications */
        .notifications {
            position: relative;
        }
        
        .notification-bell {
            width: 20px;
            height: 20px;
            cursor: pointer;
            color: var(--text-light);
        }
        
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: var(--white);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }
        
        /* Profile Menu */
        .profile-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        
        .profile-menu:hover {
            background: var(--surface);
        }
        
        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
        }
        
        .profile-name {
            font-size: 14px;
            font-weight: 500;
        }
        
        .profile-role {
            font-size: 12px;
            color: var(--text-light);
        }
        
        /* Content Area */
        .content-area {
            padding: 24px;
            flex: 1;
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        
        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: var(--surface-dark);
            color: var(--text);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 12px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .topbar-right {
                gap: 8px;
            }
            
            .usage-bar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/dashboard" class="logo">Domus</a>
                <div class="logo-subtitle">Planning Intelligence</div>
            </div>
            
            <div class="nav-section">
                <a href="/dashboard" class="nav-item" data-route="/dashboard">
                    <span class="nav-item-icon">📊</span>
                    <span class="nav-item-text">Dashboard</span>
                </a>
            </div>
            
            <!-- Dynamic navigation sections will be populated by JavaScript -->
            <div id="navigation-sections"></div>
            
        </nav>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Topbar -->
            <header class="topbar">
                <div class="topbar-left">
                    <div class="breadcrumb" id="breadcrumb">{{ breadcrumb | default("Dashboard") }}</div>
                    <div class="page-title" id="page-title">{{ page_title | default("Welcome") }}</div>
                </div>
                
                <div class="topbar-right">
                    <!-- Usage Bar -->
                    <div class="usage-bar" id="usage-bar">
                        <div class="usage-indicator">
                            <div class="usage-dot good"></div>
                            <span>Projects: <span id="projects-usage">0/10</span></span>
                        </div>
                        <div class="usage-indicator">
                            <div class="usage-dot good"></div>
                            <span>Docs: <span id="docs-usage">0/50</span></span>
                        </div>
                    </div>
                    
                    <!-- Notifications -->
                    <div class="notifications">
                        <div class="notification-bell">🔔</div>
                        <div class="notification-badge hidden" id="notification-count">0</div>
                    </div>
                    
                    <!-- Profile Menu -->
                    <div class="profile-menu" onclick="toggleProfileMenu()">
                        <div class="profile-avatar" id="profile-avatar">U</div>
                        <div class="profile-info">
                            <div class="profile-name" id="profile-name">User</div>
                            <div class="profile-role" id="profile-role">Developer</div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <div class="content-area">
                {% block content %}
                <div id="app-content">
                    <!-- Dynamic content will be loaded here -->
                </div>
                {% endblock %}
            </div>
        </main>
    </div>
    
    <!-- JavaScript for App Shell Functionality -->
    <script>
        // Global app state
        window.DomusApp = {
            currentUser: null,
            currentOrg: null,
            permissions: [],
            usage: {},
            navigationConfig: []
        };
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        async function initializeApp() {
            try {
                // Load user session
                await loadUserSession();
                
                // Load usage information
                await loadUsageInformation();
                
                // Build navigation based on permissions
                buildNavigation();
                
                // Set up routing
                setupRouting();
                
                // Load initial content
                await loadCurrentPage();
                
                console.log('✅ Domus app initialized successfully');
            } catch (error) {
                console.error('❌ Failed to initialize app:', error);
                handleInitializationError(error);
            }
        }
        
        async function loadUserSession() {
            try {
                const response = await fetch('/api/session');
                if (!response.ok) {
                    throw new Error('Failed to load session');
                }
                
                const data = await response.json();
                window.DomusApp.currentUser = data.user;
                window.DomusApp.currentOrg = data.org;
                
                // Update profile UI
                updateProfileUI(data.user);
                
            } catch (error) {
                console.error('Session load failed:', error);
                // Redirect to login if session is invalid
                window.location.href = '/login';
            }
        }
        
        async function loadUsageInformation() {
            try {
                const response = await fetch('/api/usage');
                if (response.ok) {
                    const usage = await response.json();
                    window.DomusApp.usage = usage;
                    updateUsageBar(usage);
                }
            } catch (error) {
                console.error('Failed to load usage:', error);
            }
        }
        
        function updateProfileUI(user) {
            document.getElementById('profile-name').textContent = user.email.split('@')[0];
            document.getElementById('profile-role').textContent = user.role.replace('_', ' ').toLowerCase();
            document.getElementById('profile-avatar').textContent = user.email[0].toUpperCase();
        }
        
        function updateUsageBar(usage) {
            if (usage.quotas) {
                // Update projects usage
                const projectsUsage = usage.quotas.projects;
                if (projectsUsage) {
                    const projectsText = projectsUsage.unlimited ? 
                        `${projectsUsage.current}/∞` : 
                        `${projectsUsage.current}/${projectsUsage.limit}`;
                    document.getElementById('projects-usage').textContent = projectsText;
                }
                
                // Update docs usage
                const docsUsage = usage.quotas.docs;
                if (docsUsage) {
                    const docsText = docsUsage.unlimited ? 
                        `${docsUsage.current}/∞` : 
                        `${docsUsage.current}/${docsUsage.limit}`;
                    document.getElementById('docs-usage').textContent = docsText;
                }
            }
        }
        
        function buildNavigation() {
            const user = window.DomusApp.currentUser;
            if (!user) return;
            
            // Navigation configuration based on role
            const navigationSections = getNavigationForRole(user.role);
            window.DomusApp.navigationConfig = navigationSections;
            
            // Build navigation HTML
            const sectionsContainer = document.getElementById('navigation-sections');
            sectionsContainer.innerHTML = '';
            
            navigationSections.forEach(section => {
                const sectionElement = createNavigationSection(section);
                sectionsContainer.appendChild(sectionElement);
            });
        }
        
        function getNavigationForRole(role) {
            // Base navigation - all roles get dashboard
            const sections = [];
            
            // Projects section (DEV, CON, ADM)
            if (['developer', 'consultant', 'admin'].includes(role)) {
                sections.push({
                    title: 'Projects',
                    icon: '📁',
                    route: '/projects',
                    items: [
                        { title: 'All Projects', route: '/projects' },
                        { title: 'New Project', route: '/projects/new' }
                    ]
                });
                
                sections.push({
                    title: 'Planning Services',
                    icon: '💡',
                    items: [
                        { title: 'Planning AI', route: '/planning-ai' },
                        { title: 'Auto-Docs', route: '/auto-docs' },
                        { title: 'Property API', route: '/property-api' },
                        { title: 'Offsets Marketplace', route: '/offsets-marketplace' },
                        { title: 'Communications Hub', route: '/communications-hub' },
                        { title: 'Documents Hub', route: '/documents' }
                    ]
                });
            }
            
            // Marketplace section
            const marketplaceItems = [];
            if (role === 'landowner' || role === 'admin') {
                marketplaceItems.push({ title: 'Supply Listings', route: '/marketplace/supply' });
            }
            if (['developer', 'consultant', 'admin'].includes(role)) {
                marketplaceItems.push({ title: 'Demand Posts', route: '/marketplace/demand' });
            }
            if (marketplaceItems.length > 0) {
                marketplaceItems.push({ title: 'Contracts', route: '/contracts' });
                sections.push({
                    title: 'Marketplace',
                    icon: '🏪',
                    items: marketplaceItems
                });
            }
            
            // Analytics (all roles)
            sections.push({
                title: 'Analytics',
                icon: '📈',
                route: '/analytics'
            });
            
            // Settings (all roles)
            const settingsItems = [
                { title: 'Profile', route: '/settings' },
                { title: 'Billing', route: '/settings/billing' }
            ];
            if (window.DomusApp.currentOrg?.plan === 'enterprise') {
                settingsItems.push({ title: 'API Keys', route: '/settings/api-keys' });
            }
            sections.push({
                title: 'Settings',
                icon: '⚙️',
                items: settingsItems
            });
            
            // Admin section (admin only)
            if (role === 'admin') {
                sections.push({
                    title: 'Admin',
                    icon: '🛡️',
                    route: '/admin'
                });
            }
            
            return sections;
        }
        
        function createNavigationSection(section) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'nav-section';
            
            if (section.route && !section.items) {
                // Simple nav item
                const navItem = document.createElement('a');
                navItem.href = section.route;
                navItem.className = 'nav-item';
                navItem.dataset.route = section.route;
                navItem.innerHTML = `
                    <span class="nav-item-icon">${section.icon}</span>
                    <span class="nav-item-text">${section.title}</span>
                `;
                navItem.onclick = (e) => navigateToPage(e, section.route);
                sectionDiv.appendChild(navItem);
            } else if (section.items) {
                // Section with submenu
                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'nav-section-title';
                sectionTitle.textContent = section.title;
                sectionDiv.appendChild(sectionTitle);
                
                const submenu = document.createElement('div');
                submenu.className = 'nav-submenu';
                
                section.items.forEach(item => {
                    const navItem = document.createElement('a');
                    navItem.href = item.route;
                    navItem.className = 'nav-item';
                    navItem.dataset.route = item.route;
                    navItem.textContent = item.title;
                    navItem.onclick = (e) => navigateToPage(e, item.route);
                    submenu.appendChild(navItem);
                });
                
                sectionDiv.appendChild(submenu);
            }
            
            return sectionDiv;
        }
        
        function setupRouting() {
            // Handle browser back/forward buttons
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.route) {
                    loadPage(event.state.route);
                } else {
                    loadPage(window.location.pathname);
                }
            });
        }
        
        async function navigateToPage(event, route) {
            event.preventDefault();
            
            // Update URL without page refresh
            history.pushState({ route }, '', route);
            
            // Load the page content
            await loadPage(route);
            
            // Update active navigation
            updateActiveNavigation(route);
        }
        
        async function loadCurrentPage() {
            const currentPath = window.location.pathname;
            await loadPage(currentPath);
            updateActiveNavigation(currentPath);
        }
        
        async function loadPage(route) {
            try {
                // Update breadcrumb and page title
                updatePageInfo(route);
                
                // Load page content
                const content = await getPageContent(route);
                document.getElementById('app-content').innerHTML = content;
                
                // Execute any page-specific JavaScript
                executePageScripts(route);
                
            } catch (error) {
                console.error('Failed to load page:', error);
                showErrorPage(error);
            }
        }
        
        function updatePageInfo(route) {
            const pageInfo = getPageInfo(route);
            document.getElementById('breadcrumb').textContent = pageInfo.breadcrumb;
            document.getElementById('page-title').textContent = pageInfo.title;
            document.title = `${pageInfo.title} - Domus Planning Platform`;
        }
        
        function getPageInfo(route) {
            const pages = {
                '/dashboard': { title: 'Dashboard', breadcrumb: 'Overview' },
                '/projects': { title: 'All Projects', breadcrumb: 'Projects > All Projects' },
                '/projects/new': { title: 'New Project', breadcrumb: 'Projects > New Project' },
                '/planning-ai': { title: 'Planning AI', breadcrumb: 'Planning Services > Planning AI' },
                '/auto-docs': { title: 'Auto-Docs', breadcrumb: 'Planning Services > Auto-Docs' },
                '/property-api': { title: 'Property API', breadcrumb: 'Planning Services > Property API' },
                '/offsets-marketplace': { title: 'Offsets Marketplace', breadcrumb: 'Planning Services > Offsets Marketplace' },
                '/communications-hub': { title: 'Communications Hub', breadcrumb: 'Planning Services > Communications Hub' },
                '/documents': { title: 'Documents Hub', breadcrumb: 'Planning Services > Documents Hub' },
                '/marketplace/supply': { title: 'Supply Listings', breadcrumb: 'Marketplace > Supply Listings' },
                '/marketplace/demand': { title: 'Demand Posts', breadcrumb: 'Marketplace > Demand Posts' },
                '/contracts': { title: 'Contracts', breadcrumb: 'Marketplace > Contracts' },
                '/analytics': { title: 'Analytics', breadcrumb: 'Analytics' },
                '/settings': { title: 'Profile Settings', breadcrumb: 'Settings > Profile' },
                '/settings/billing': { title: 'Billing', breadcrumb: 'Settings > Billing' },
                '/settings/api-keys': { title: 'API Keys', breadcrumb: 'Settings > API Keys' },
                '/admin': { title: 'Admin Panel', breadcrumb: 'Admin' }
            };
            
            return pages[route] || { title: 'Page', breadcrumb: 'Navigation' };
        }
        
        async function getPageContent(route) {
            // For now, return placeholder content
            // In a real implementation, this would fetch from appropriate endpoints
            const pages = {
                '/dashboard': getDashboardContent(),
                '/projects': getProjectsContent(),
                '/projects/new': getNewProjectContent(),
                '/planning-ai': getPlanningAIContent(),
                '/auto-docs': getAutoDocsContent(),
                '/property-api': getPropertyAPIContent(),
                '/offsets-marketplace': getOffsetsMarketplaceContent(),
                '/communications-hub': getCommunicationsHubContent(),
                '/documents': getDocumentsContent(),
                '/marketplace/supply': getSupplyContent(),
                '/marketplace/demand': getDemandContent(),
                '/contracts': getContractsContent(),
                '/analytics': getAnalyticsContent(),
                '/settings': getSettingsContent(),
                '/settings/billing': getBillingContent(),
                '/settings/api-keys': getAPIKeysContent(),
                '/admin': getAdminContent()
            };
            
            return pages[route] || getNotFoundContent();
        }
        
        function updateActiveNavigation(route) {
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to current route
            const activeItem = document.querySelector(`[data-route="${route}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        
        function executePageScripts(route) {
            // Execute page-specific JavaScript
            // This would be where page components initialize
            console.log(`Executing scripts for ${route}`);
        }
        
        function showErrorPage(error) {
            document.getElementById('app-content').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2>⚠️ Something went wrong</h2>
                    <p style="color: var(--text-light); margin: 16px 0;">We encountered an error loading this page.</p>
                    <button class="btn btn-primary" onclick="window.location.reload()">Refresh Page</button>
                </div>
            `;
        }
        
        function handleInitializationError(error) {
            document.body.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100vh; text-align: center;">
                    <div>
                        <h1>🚫 Initialization Error</h1>
                        <p style="color: var(--text-light); margin: 16px 0;">The application failed to initialize properly.</p>
                        <button class="btn btn-primary" onclick="window.location.reload()">Try Again</button>
                    </div>
                </div>
            `;
        }
        
        function toggleProfileMenu() {
            // Implementation for profile menu dropdown
            console.log('Profile menu toggled');
        }
        
        // Placeholder content functions
        async function getDashboardContent() {
            try {
                // Load dashboard data from API
                const [overviewRes, projectsRes, notificationsRes] = await Promise.all([
                    fetch('/api/dashboard/overview'),
                    fetch('/api/dashboard/recent-projects'),
                    fetch('/api/dashboard/notifications')
                ]);
                
                const overview = await overviewRes.json();
                const recentProjects = await projectsRes.json();
                const notifications = await notificationsRes.json();
                
                return buildDashboardHTML(overview, recentProjects, notifications);
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                return getPlaceholderDashboard();
            }
        }
        
        function buildDashboardHTML(overview, recentProjects, notifications) {
            const user = window.DomusApp.currentUser;
            const role = user?.role || 'developer';
            
            return `
                <div class="dashboard-container">
                    <div class="dashboard-header">
                        <h1>Welcome back, ${user?.email?.split('@')[0] || 'User'}!</h1>
                        <p>Here's what's happening with your planning projects</p>
                    </div>
                    
                    <div class="dashboard-grid">
                        ${buildMetricsWidget(overview.metrics, role)}
                        ${buildQuickActionsWidget(overview.quick_actions, role)}
                        ${buildRecentProjectsWidget(recentProjects)}
                        ${buildUsageWidget()}
                        ${buildRecentActivityWidget(overview.recent_activity)}
                        ${buildNotificationsWidget(notifications)}
                    </div>
                </div>
            `;
        }
        
        function buildMetricsWidget(metrics, role) {
            let metricsHTML = '';
            
            if (role === 'developer' || role === 'consultant' || role === 'admin') {
                metricsHTML = `
                    <div class="metric-item">
                        <span class="metric-value">${metrics.total_projects}</span>
                        <div class="metric-label">Total Projects</div>
                    </div>
                    <div class="metric-item">
                        <span class="metric-value">${metrics.approval_rate}%</span>
                        <div class="metric-label">Approval Rate</div>
                        <div class="metric-change positive">+5.2% vs last month</div>
                    </div>
                    <div class="metric-item">
                        <span class="metric-value">${metrics.time_saved}h</span>
                        <div class="metric-label">Time Saved</div>
                        <div class="metric-change positive">+12h this month</div>
                    </div>
                    <div class="metric-item">
                        <span class="metric-value">£${metrics.cost_saved.toLocaleString()}</span>
                        <div class="metric-label">Cost Saved</div>
                        <div class="metric-change positive">+£3,500 this month</div>
                    </div>
                `;
            } else if (role === 'landowner') {
                // Different metrics for landowners
                metricsHTML = `
                    <div class="metric-item">
                        <span class="metric-value">5</span>
                        <div class="metric-label">Active Listings</div>
                    </div>
                    <div class="metric-item">
                        <span class="metric-value">£45,000</span>
                        <div class="metric-label">Total Earnings</div>
                        <div class="metric-change positive">+£12,000 this month</div>
                    </div>
                    <div class="metric-item">
                        <span class="metric-value">3</span>
                        <div class="metric-label">Units Sold</div>
                        <div class="metric-change positive">+1 this month</div>
                    </div>
                    <div class="metric-item">
                        <span class="metric-value">15.2</span>
                        <div class="metric-label">Available Units</div>
                    </div>
                `;
            }
            
            return `
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Performance Overview</h3>
                        <a href="/analytics" class="widget-action">View Details →</a>
                    </div>
                    <div class="widget-content">
                        <div class="metric-grid">
                            ${metricsHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function buildQuickActionsWidget(actions, role) {
            const filteredActions = filterActionsByRole(actions, role);
            
            const actionsHTML = filteredActions.map(action => `
                <a href="${action.route}" class="quick-action">
                    <div class="quick-action-icon">${action.icon}</div>
                    <div class="quick-action-title">${action.title}</div>
                    <div class="quick-action-description">${action.description}</div>
                </a>
            `).join('');
            
            return `
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Quick Actions</h3>
                    </div>
                    <div class="widget-content">
                        <div class="quick-actions-grid">
                            ${actionsHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function filterActionsByRole(actions, role) {
            // Filter actions based on user role
            if (role === 'landowner') {
                return [
                    {
                        title: "List Units",
                        description: "Create new biodiversity unit listing",
                        route: "/marketplace/supply",
                        icon: "🏞️",
                        color: "primary"
                    },
                    {
                        title: "View Contracts",
                        description: "Check contract status",
                        route: "/contracts",
                        icon: "📋",
                        color: "secondary"
                    }
                ];
            }
            
            return actions;
        }
        
        function buildRecentProjectsWidget(projects) {
            const projectsHTML = projects.slice(0, 5).map(project => `
                <li class="recent-item">
                    <div class="recent-icon">📁</div>
                    <div class="recent-content">
                        <div class="recent-title">${project.title}</div>
                        <div class="recent-meta">${project.address} • Score: ${project.ai_score}%</div>
                    </div>
                    <div class="recent-status ${project.status}">${project.status}</div>
                </li>
            `).join('');
            
            return `
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Recent Projects</h3>
                        <a href="/projects" class="widget-action">View All →</a>
                    </div>
                    <div class="widget-content">
                        <ul class="recent-list">
                            ${projectsHTML}
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function buildUsageWidget() {
            const usage = window.DomusApp.usage;
            if (!usage || !usage.quotas) {
                return '';
            }
            
            const usageItems = Object.entries(usage.quotas).map(([key, quota]) => {
                const percentage = quota.unlimited ? 0 : (quota.current / quota.limit * 100);
                const level = percentage > 80 ? 'high' : percentage > 60 ? 'medium' : 'low';
                const displayValue = quota.unlimited ? `${quota.current}/∞` : `${quota.current}/${quota.limit}`;
                
                return `
                    <div class="usage-item">
                        <div class="usage-header">
                            <span class="usage-label">${key.replace('_', ' ').toUpperCase()}</span>
                            <span class="usage-value">${displayValue}</span>
                        </div>
                        <div class="usage-bar">
                            <div class="usage-fill ${level}" style="width: ${quota.unlimited ? 30 : percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Usage Overview</h3>
                        <a href="/settings/billing" class="widget-action">Upgrade →</a>
                    </div>
                    <div class="widget-content">
                        ${usageItems}
                    </div>
                </div>
            `;
        }
        
        function buildRecentActivityWidget(activities) {
            const activitiesHTML = activities.slice(0, 5).map(activity => `
                <li class="recent-item">
                    <div class="recent-icon">${activity.icon}</div>
                    <div class="recent-content">
                        <div class="recent-title">${activity.title}</div>
                        <div class="recent-meta">${activity.description}</div>
                    </div>
                </li>
            `).join('');
            
            return `
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Recent Activity</h3>
                    </div>
                    <div class="widget-content">
                        <ul class="recent-list">
                            ${activitiesHTML}
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function buildNotificationsWidget(notifications) {
            const unreadCount = notifications.filter(n => !n.read).length;
            const notificationsHTML = notifications.slice(0, 3).map(notification => `
                <li class="notification-item">
                    <div class="notification-icon ${notification.type}">
                        ${notification.type === 'success' ? '✓' : notification.type === 'warning' ? '⚠' : 'ℹ'}
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${formatRelativeTime(notification.timestamp)}</div>
                    </div>
                </li>
            `).join('');
            
            return `
                <div class="dashboard-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Notifications ${unreadCount > 0 ? `(${unreadCount})` : ''}</h3>
                        <a href="#" class="widget-action">View All →</a>
                    </div>
                    <div class="widget-content">
                        <ul class="notification-list">
                            ${notificationsHTML}
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function formatRelativeTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            
            if (diffHours >= 24) {
                return `${Math.floor(diffHours / 24)} days ago`;
            } else if (diffHours >= 1) {
                return `${diffHours} hours ago`;
            } else {
                return `${diffMinutes} minutes ago`;
            }
        }
        
        function getPlaceholderDashboard() {
            return `
                <div>
                    <h1>Dashboard</h1>
                    <p>Welcome to your Domus Planning Platform dashboard.</p>
                    <div style="margin-top: 20px;">
                        <div class="quick-actions">
                            <a href="/projects/new" class="btn btn-primary">New Project</a>
                            <a href="/planning-ai" class="btn btn-secondary">Run Analysis</a>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getProjectsContent() {
            return `
                <div>
                    <h1>Projects</h1>
                    <p>Manage your planning projects</p>
                    <div class="quick-actions" style="margin: 20px 0;">
                        <a href="/projects/new" class="btn btn-primary">New Project</a>
                    </div>
                    <p style="color: var(--text-light);">Project list will be loaded here...</p>
                </div>
            `;
        }
        
        function getNewProjectContent() {
            return `
                <div>
                    <h1>New Project</h1>
                    <p>Create a new planning project</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Project creation form will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getPlanningAIContent() {
            return `
                <div>
                    <h1>Planning AI</h1>
                    <p>AI-powered planning analysis and insights</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Planning AI interface will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getAutoDocsContent() {
            return `
                <div>
                    <h1>Auto-Docs</h1>
                    <p>Automated document generation</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Document generation interface will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getPropertyAPIContent() {
            return `
                <div>
                    <h1>Property API</h1>
                    <p>UK property data integration</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Property API interface will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getOffsetsMarketplaceContent() {
            return `
                <div>
                    <h1>Offsets Marketplace</h1>
                    <p>Biodiversity Net Gain trading platform</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Offsets marketplace interface will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getCommunicationsHubContent() {
            return `
                <div>
                    <h1>Communications Hub</h1>
                    <p>Unified client messaging, consultations, and stakeholder engagement</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Communications hub interface will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getDocumentsContent() {
            return `
                <div>
                    <h1>Documents Hub</h1>
                    <p>Manage your planning documents</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Documents list will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getSupplyContent() {
            return `
                <div>
                    <h1>Supply Listings</h1>
                    <p>Manage your biodiversity unit listings</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Supply listings will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getDemandContent() {
            return `
                <div>
                    <h1>Demand Posts</h1>
                    <p>Find biodiversity units for your projects</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Demand interface will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getContractsContent() {
            return `
                <div>
                    <h1>Contracts</h1>
                    <p>Manage your marketplace contracts</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Contracts list will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getAnalyticsContent() {
            return `
                <div>
                    <h1>Analytics</h1>
                    <p>View your platform analytics and insights</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Analytics dashboard will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getSettingsContent() {
            return `
                <div>
                    <h1>Profile Settings</h1>
                    <p>Manage your account settings</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Settings form will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getBillingContent() {
            return `
                <div>
                    <h1>Billing</h1>
                    <p>Manage your subscription and billing</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Billing interface will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getAPIKeysContent() {
            return `
                <div>
                    <h1>API Keys</h1>
                    <p>Manage your API keys and integrations</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">API keys management will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getAdminContent() {
            return `
                <div>
                    <h1>Admin Panel</h1>
                    <p>System administration and monitoring</p>
                    <div style="margin-top: 20px;">
                        <p style="color: var(--text-light);">Admin interface will be loaded here...</p>
                    </div>
                </div>
            `;
        }
        
        function getNotFoundContent() {
            return `
                <div style="text-align: center; padding: 40px;">
                    <h2>404 - Page Not Found</h2>
                    <p style="color: var(--text-light); margin: 16px 0;">The page you're looking for doesn't exist.</p>
                    <a href="/dashboard" class="btn btn-primary">Go to Dashboard</a>
                </div>
            `;
        }
    </script>
</body>
</html>