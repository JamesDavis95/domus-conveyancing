<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Domus Global</title>
  <!-- Leaflet CSS for Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --line: #1f2937;
      --btn: #1d4ed8;
      --btnh: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --sidebar-width: 260px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      background: var(--bg);
      color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, 'Segoe UI', sans-serif;
      overflow-x: hidden;
    }
    
    /* Header */
    .header {
      background: var(--panel);
      border-bottom: 1px solid var(--line);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .logo {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(45deg, #60a5fa, #34d399);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .user-menu {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 13px;
    }
    
    /* Layout */
    .app-layout {
      display: flex;
      min-height: calc(100vh - 60px);
    }
    
    /* Sidebar Navigation */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--panel);
      border-right: 1px solid var(--line);
      padding: 24px 0;
      overflow-y: auto;
    }
    
    .nav-section {
      margin-bottom: 32px;
    }
    
    .nav-section-title {
      padding: 0 24px;
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 24px;
      color: var(--text);
      text-decoration: none;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 14px;
    }
    
    .nav-item:hover,
    .nav-item.active {
      background: var(--bg);
      color: var(--success);
    }
    
    .nav-item .icon {
      width: 18px;
      height: 18px;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
      max-width: calc(100vw - var(--sidebar-width));
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
      animation: fadeIn 0.2s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .page-header {
      margin-bottom: 32px;
    }
    
    .page-title {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 8px 0;
    }
    
    .page-subtitle {
      color: var(--muted);
      font-size: 16px;
      margin: 0;
    }
    
    /* Components */
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .panel h2 {
      margin: 0 0 20px 0;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .panel h3 {
      margin: 0 0 16px 0;
      font-size: 16px;
      color: var(--muted);
    }
    
    .grid {
      display: grid;
      gap: 24px;
    }
    
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    
    .stat-card {
      background: var(--bg);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--line);
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    
    .stat-card .label {
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
    }
    
    .stat-card .trend {
      font-size: 12px;
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .trend.up { color: var(--success); }
    .trend.down { color: var(--danger); }
    
    /* Forms */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text);
      font-weight: 500;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--btn);
      box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.1);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    /* Buttons */
    .btn {
      padding: 12px 20px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .btn:hover { background: var(--panel); }
    .btn.primary { background: var(--btn); border-color: var(--btn); color: white; }
    .btn.primary:hover { background: var(--btnh); }
    .btn.success { background: var(--success); border-color: var(--success); color: white; }
    .btn.danger { background: var(--danger); border-color: var(--danger); color: white; }
    .btn.sm { padding: 8px 12px; font-size: 12px; }
    
    /* Tables */
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .table th,
    .table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid var(--line);
    }
    
    .table th {
      background: var(--bg);
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table tbody tr {
      transition: background 0.2s;
    }
    
    .table tbody tr:hover {
      background: var(--bg);
    }
    
    /* Status badges */
    .status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status.active { background: var(--success); color: white; }
    .status.pending { background: var(--warning); color: white; }
    .status.inactive { background: var(--muted); color: white; }
    .status.draft { background: var(--line); color: var(--muted); }
    
    /* Utilities */
    .flex { display: flex; }
    .flex-between { justify-content: space-between; }
    .flex-center { align-items: center; }
    .gap-2 { gap: 8px; }
    .gap-3 { gap: 12px; }
    .gap-4 { gap: 16px; }
    .mb-0 { margin-bottom: 0; }
    .mb-2 { margin-bottom: 8px; }
    .mb-3 { margin-bottom: 12px; }
    .mb-4 { margin-bottom: 16px; }
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-danger { color: var(--danger); }
    .text-muted { color: var(--muted); }
    .text-sm { font-size: 12px; }
    .fw-500 { font-weight: 500; }
    .fw-600 { font-weight: 600; }
    
    /* Loading states */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--line);
      border-radius: 50%;
      border-top-color: var(--btn);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Header Actions */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .search-box input {
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 8px 16px;
      color: var(--text);
      width: 300px;
      font-size: 14px;
    }
    
    .search-box input::placeholder {
      color: var(--muted);
    }
    
    /* Notifications */
    .notifications-container {
      position: relative;
    }
    
    .notification-btn {
      background: none;
      border: none;
      color: var(--text);
      font-size: 16px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      position: relative;
      transition: background 0.2s;
    }
    
    .notification-btn:hover {
      background: var(--line);
    }
    
    .notification-badge {
      background: var(--danger);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 4px;
      min-width: 18px;
      text-align: center;
    }
    
    .notifications-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      width: 360px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      display: none;
      z-index: 1000;
      max-height: 400px;
      overflow: hidden;
    }
    
    .notifications-dropdown.show {
      display: block;
    }
    
    .notifications-header {
      padding: 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .notifications-header h3 {
      font-size: 16px;
      font-weight: 600;
    }
    
    .mark-all-read {
      background: none;
      border: none;
      color: var(--btn);
      font-size: 12px;
      cursor: pointer;
    }
    
    .notifications-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }
    
    .notification-item:hover {
      background: var(--bg);
    }
    
    .notification-item.unread {
      background: rgba(29, 78, 216, 0.1);
      border-left: 3px solid var(--btn);
    }
    
    .notification-item.unread::before {
      content: '';
      position: absolute;
      top: 16px;
      right: 16px;
      width: 8px;
      height: 8px;
      background: var(--btn);
      border-radius: 50%;
    }
    
    .notification-icon {
      font-size: 18px;
      margin-right: 8px;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .notification-message {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 4px;
    }
    
    .notification-time {
      color: var(--muted);
      font-size: 11px;
    }
    
    .notification-loading {
      padding: 20px;
      text-align: center;
      color: var(--muted);
    }
    
    .notifications-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--line);
      text-align: center;
    }
    
    .view-all-btn {
      background: none;
      border: none;
      color: var(--btn);
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
    }
    
    .view-all-btn:hover {
      text-decoration: underline;
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 24px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .toast {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      min-width: 300px;
      max-width: 400px;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      border-left: 4px solid var(--success);
    }
    
    .toast.warning {
      border-left: 4px solid var(--warning);
    }
    
    .toast.error {
      border-left: 4px solid var(--danger);
    }
    
    .toast-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .toast-title {
      font-weight: 600;
      font-size: 14px;
    }
    
    .toast-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 18px;
    }
    
    .toast-message {
      color: var(--muted);
      font-size: 13px;
    }
    
    /* AI Helpbot */
    .helpbot-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 2000;
    }
    
    .helpbot-toggle {
      background: linear-gradient(135deg, #1d4ed8, #2563eb);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(29, 78, 216, 0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .helpbot-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(29, 78, 216, 0.4);
    }
    
    .helpbot-panel {
      position: absolute;
      bottom: 60px;
      right: 0;
      width: 380px;
      height: 500px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    
    .helpbot-panel.show {
      display: flex;
    }
    
    .helpbot-header {
      padding: 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .helpbot-header h3 {
      font-size: 16px;
      font-weight: 600;
    }
    
    .helpbot-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .helpbot-message {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    
    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 16px;
      background: var(--btn);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .user-message .message-avatar {
      background: var(--muted);
    }
    
    .message-content {
      flex: 1;
      background: var(--bg);
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
    }
    
    .message-content p {
      margin: 0 0 8px 0;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .message-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .action-btn {
      background: var(--btn);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .action-btn:hover {
      background: var(--btnh);
    }
    
    .helpbot-input {
      padding: 16px;
      border-top: 1px solid var(--line);
      display: flex;
      gap: 8px;
    }
    
    .helpbot-input input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text);
      font-size: 14px;
    }
    
    .send-btn {
      background: var(--btn);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .send-btn:hover {
      background: var(--btnh);
    }
    
    /* Property Map Modal */
    .map-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    
    .map-modal.show {
      display: flex;
    }
    
    .map-modal-content {
      background: var(--panel);
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      height: 80%;
      max-height: 600px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .map-modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .map-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .map-placeholder {
      flex: 1;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }
    
    .property-pin {
      font-size: 48px;
      margin-bottom: 20px;
    }
    
    .property-info {
      text-align: center;
      color: var(--text);
    }
    
    .property-info h4 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    
    .map-insights {
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      border-top: 1px solid var(--line);
    }
    
    .insight-card {
      background: var(--bg);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--line);
    }
    
    .insight-card h4 {
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--text);
    }
    
    .insight-card p {
      font-size: 13px;
      color: var(--muted);
      margin: 4px 0;
    }
    
    .positive {
      color: var(--success);
      font-weight: 600;
    }
    
    /* Enhanced Search Box */
    .search-box {
      position: relative;
    }
    
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--panel);
      border: 1px solid var(--line);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .search-suggestions.show {
      display: block;
    }
    
    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--line);
      transition: background 0.2s;
    }
    
    .suggestion-item:hover {
      background: var(--bg);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-title {
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .suggestion-subtitle {
      font-size: 12px;
      color: var(--muted);
    }
    
    /* ==================== AI COMPONENTS STYLES ==================== */
    
    /* AI Helpbot */
    .helpbot-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 2000;
    }
    
    .helpbot-toggle {
      background: linear-gradient(45deg, #1d4ed8, #3b82f6);
      border: none;
      border-radius: 50px;
      padding: 16px 20px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(29, 78, 216, 0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .helpbot-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(29, 78, 216, 0.4);
    }
    
    .helpbot-text {
      font-size: 14px;
    }
    
    .helpbot-chat {
      position: absolute;
      bottom: 70px;
      right: 0;
      width: 380px;
      height: 500px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    
    .helpbot-chat.show {
      display: flex;
    }
    
    .helpbot-header {
      background: linear-gradient(45deg, #1d4ed8, #3b82f6);
      color: white;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .helpbot-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    
    .helpbot-icon {
      font-size: 18px;
    }
    
    .helpbot-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    
    .helpbot-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .helpbot-message {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    
    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--btn);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .helpbot-message.bot .message-avatar {
      background: linear-gradient(45deg, #1d4ed8, #3b82f6);
    }
    
    .helpbot-message.user .message-avatar {
      background: var(--success);
      color: white;
    }
    
    .message-content {
      flex: 1;
      background: var(--bg);
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
    }
    
    .message-content p {
      margin: 0 0 8px 0;
      line-height: 1.4;
    }
    
    .message-content ul {
      margin: 8px 0;
      padding-left: 20px;
    }
    
    .message-content li {
      margin: 4px 0;
      line-height: 1.4;
    }
    
    .helpbot-input {
      padding: 16px;
      border-top: 1px solid var(--line);
      display: flex;
      gap: 8px;
    }
    
    .helpbot-input input {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
    }
    
    .helpbot-input button {
      padding: 12px 16px;
      background: var(--btn);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .helpbot-suggestions {
      padding: 16px;
      border-top: 1px solid var(--line);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .suggestion-btn {
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .suggestion-btn:hover {
      background: var(--btn);
      color: white;
      border-color: var(--btn);
    }
    
    /* AI Upload Zone */
    .ai-upload-zone {
      border: 2px dashed var(--line);
      border-radius: 16px;
      padding: 32px 24px;
      text-align: center;
      background: var(--bg);
      margin: 16px 0;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .ai-upload-zone:hover, .ai-upload-zone.drag-over {
      border-color: var(--btn);
      background: rgba(29, 78, 216, 0.1);
      transform: scale(1.02);
    }
    
    .upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .ai-upload-zone h3 {
      margin: 16px 0 8px 0;
      color: var(--text);
    }
    
    .ai-upload-zone p {
      color: var(--muted);
      margin-bottom: 16px;
    }
    
    .ai-features {
      text-align: left;
      display: inline-block;
      margin: 16px 0;
    }
    
    .ai-features li {
      margin: 8px 0;
      color: var(--text);
      font-size: 14px;
    }
    
    /* AI Processing */
    .ai-processing {
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
    }
    
    .processing-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .processing-icon {
      font-size: 32px;
      animation: spin 2s linear infinite;
    }
    
    .processing-header h4 {
      margin: 0 0 4px 0;
      color: var(--text);
    }
    
    .processing-header p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }
    
    .progress-bar {
      background: var(--line);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    .progress-fill {
      background: linear-gradient(45deg, #1d4ed8, #3b82f6);
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
    }
    
    .processing-steps {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .processing-step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--panel);
      border-radius: 8px;
      font-size: 14px;
    }
    
    .processing-step.active {
      background: rgba(29, 78, 216, 0.1);
      border-left: 3px solid var(--btn);
    }
    
    .processing-step.completed {
      color: var(--success);
    }
    
    /* AI Results Panel */
    .ai-results-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: var(--bg);
      border-radius: 8px;
      padding: 4px;
    }
    
    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: none;
      color: var(--muted);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .tab-btn.active {
      background: var(--btn);
      color: white;
    }
    
    .ai-tab-content {
      background: var(--bg);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--line);
    }
    
    /* Property Map */
    .property-map-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      height: 400px;
    }
    
    .property-map {
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }
    
    #property-leaflet-map {
      height: 100%;
      width: 100%;
      border-radius: 8px;
    }
    
    .leaflet-popup-content-wrapper {
      background: var(--panel) !important;
      color: var(--text) !important;
      border-radius: 8px !important;
      border: 1px solid var(--line) !important;
    }
    
    .leaflet-popup-tip {
      background: var(--panel) !important;
      border-color: var(--line) !important;
    }
    
    .map-popup {
      padding: 8px;
      color: var(--text) !important;
    }
    
    .environmental-marker {
      background: none !important;
      border: none !important;
      font-size: 16px;
    }
    
    .map-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: var(--muted);
    }
    
    .map-placeholder .map-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .map-info {
      background: var(--panel);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid var(--line);
    }
    
    .map-info h4 {
      margin: 0 0 12px 0;
      color: var(--text);
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--line);
      font-size: 14px;
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .info-label {
      color: var(--muted);
    }
    
    .info-value {
      color: var(--text);
      font-weight: 500;
    }
    
    /* Risk Assessment Styles */
    .risk-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    
    .risk-card.high {
      border-left: 4px solid var(--danger);
    }
    
    .risk-card.medium {
      border-left: 4px solid var(--warning);
    }
    
    .risk-card.low {
      border-left: 4px solid var(--success);
    }
    
    .risk-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .risk-title {
      font-weight: 600;
      color: var(--text);
    }
    
    .risk-level {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .risk-level.high {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }
    
    .risk-level.medium {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }
    
    .risk-level.low {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    
    .risk-description {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .confidence-bar {
      background: var(--line);
      height: 4px;
      border-radius: 2px;
      overflow: hidden;
    }
    
    .confidence-fill {
      background: var(--btn);
      height: 100%;
      border-radius: 2px;
    }
    
    /* Enhanced Search Box */
    .search-box.enhanced {
      position: relative;
    }
    
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--panel);
      border: 1px solid var(--line);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .search-suggestions.show {
      display: block;
    }
    
    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--line);
      transition: background 0.2s;
    }
    
    .suggestion-item:hover {
      background: var(--bg);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-title {
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .suggestion-description {
      font-size: 12px;
      color: var(--muted);
    }
    
    /* Animations */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .hidden { display: none !important; }
    
    /* Responsive */
    /* Upload Area Styles */
    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--card-bg);
      margin: 10px 0;
    }
    
    .upload-area:hover {
      border-color: var(--primary-color);
      background: rgba(74, 144, 226, 0.05);
    }
    
    .upload-area .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .upload-area h3 {
      margin: 10px 0;
      color: var(--text-primary);
    }
    
    .upload-area p {
      color: var(--text-secondary);
      margin: 5px 0;
    }
    
    .upload-area small {
      color: var(--text-muted);
      display: block;
      margin-top: 10px;
    }
    
    @media (max-width: 768px) {
      .sidebar { width: 100%; }
      .main-content { padding: 16px; }
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">Domus Global</div>
    <div class="header-actions">
      <div class="search-box">
        <input type="text" placeholder="Search everything..." id="global-search" />
      </div>
      <div class="notifications-container">
        <button class="notification-btn" onclick="toggleNotifications()" id="notification-btn">
          <span class="notification-badge" id="notification-count">0</span>
        </button>
        <div class="notifications-dropdown" id="notifications-dropdown">
          <div class="notifications-header">
            <h3>Notifications</h3>
            <button onclick="markAllNotificationsRead()" class="mark-all-read">Mark all read</button>
          </div>
          <div class="notifications-list" id="notifications-list">
            <div class="notification-loading">Loading notifications...</div>
          </div>
          <div class="notifications-footer">
            <button onclick="showPage('communications')" class="view-all-btn">View all communications</button>
          </div>
        </div>
      </div>
      <div class="user-menu">
        <div class="user-info">
          <span>👤 Admin User</span>
          <span>•</span>
          <span>East Hertfordshire Council</span>
        </div>
      </div>
    </div>
  </header>

  <!-- AI Helpbot -->
  <div class="helpbot-container" id="helpbot-container">
    <button class="helpbot-toggle" id="helpbot-toggle" onclick="toggleHelpbot()">
      <span class="helpbot-text">AI Assistant</span>
    </button>
    <div class="helpbot-chat" id="helpbot-chat">
      <div class="helpbot-header">
        <div class="helpbot-title">
          <span class="helpbot-icon">AI</span>
          <span>Domus AI Assistant</span>
        </div>
        <button class="helpbot-close" onclick="toggleHelpbot()">×</button>
      </div>
      <div class="helpbot-messages" id="helpbot-messages">
        <div class="helpbot-message bot">
          <div class="message-avatar">AI</div>
          <div class="message-content">
            <p>Hello! I'm your AI conveyancing assistant. I can help you with:</p>
            <ul>
              <li>Finding documents and matters</li>
              <li>Understanding risk assessments</li>
              <li>Timeline predictions</li>
              <li>Property mapping</li>
              <li>Platform navigation</li>
            </ul>
            <p>What would you like help with?</p>
          </div>
        </div>
      </div>
      <div class="helpbot-input">
        <input type="text" id="helpbot-input" placeholder="Ask me anything about conveyancing..." />
        <button onclick="sendHelpbotMessage()" id="helpbot-send">Send</button>
      </div>
      <div class="helpbot-suggestions" id="helpbot-suggestions">
        <button class="suggestion-btn" onclick="askHelpbot('How do I upload documents?')">📤 Upload Guide</button>
        <button class="suggestion-btn" onclick="askHelpbot('What are AI risk assessments?')">Risk Analysis</button>
        <button class="suggestion-btn" onclick="askHelpbot('Show me property mapping')">Property Maps</button>
      </div>
    </div>
  </div>

  <!-- Main App Layout -->
  <div class="app-layout">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <button class="nav-item active" onclick="showPage('dashboard')">
          <span class="icon"></span>
          Dashboard
        </button>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Operations</div>
        <button class="nav-item" onclick="showPage('matters')">
          <span class="icon"></span>
          Matters & Cases
        </button>
        <button class="nav-item" onclick="showPage('documents')">
          <span class="icon"></span>
          Document Processing
        </button>
        <button class="nav-item" onclick="showPage('workflow')">
          <span class="icon"></span>
          Workflow Management
        </button>
        <button class="nav-item" onclick="showPage('calendar')">
          <span class="icon"></span>
          Calendar & Tasks
        </button>
        <button class="nav-item" onclick="showPage('communications')">
          <span class="icon"></span>
          Communications
        </button>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Administration</div>
        <button class="nav-item" onclick="showPage('users')">
          <span class="icon"></span>
          User Management
        </button>
        <button class="nav-item" onclick="showPage('billing')">
          <span class="icon"></span>
          Financial Management
        </button>
        <button class="nav-item" onclick="showPage('integrations')">
          <span class="icon"></span>
          System Integrations
        </button>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Analytics</div>
        <button class="nav-item" onclick="showPage('reports')">
          <span class="icon">📈</span>
          Reports & Analytics
        </button>
        <button class="nav-item" onclick="showPage('compliance')">
          <span class="icon">🛡️</span>
          Compliance & Audit
        </button>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">System</div>
        <button class="nav-item" onclick="showPage('settings')">
          <span class="icon">⚙️</span>
          Settings
        </button>
        <button class="nav-item" onclick="showPage('support')">
          <span class="icon">🎧</span>
          Support
        </button>
      </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
      <!-- Dashboard Page -->
      <div id="dashboard" class="page active">
        <div class="page-header">
          <h1 class="page-title">Dashboard</h1>
          <p class="page-subtitle">Overview of your conveyancing operations</p>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-4">
          <div class="stat-card">
            <div class="value text-success">47</div>
            <div class="label">Active Matters</div>
            <div class="trend up">↗ +12% this month</div>
          </div>
          <div class="stat-card">
            <div class="value text-warning">23</div>
            <div class="label">Pending Reviews</div>
            <div class="trend down">↘ -5% this week</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">£28,450</div>
            <div class="label">Monthly Revenue</div>
            <div class="trend up">↗ +18% vs last month</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">2.3 hrs</div>
            <div class="label">Avg Processing Time</div>
            <div class="trend up">↗ 40% faster</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-2">
          <div class="panel">
            <h2>Quick Actions</h2>
            <div class="flex gap-3">
              <button class="btn primary" onclick="showPage('matters')">Create New Matter</button>
              <button class="btn" onclick="showPage('documents')">Upload Documents</button>
              <button class="btn" onclick="showPage('reports')">Generate Report</button>
            </div>
          </div>

          <div class="panel">
            <h2>System Status</h2>
            <div class="text-sm">
              <div class="flex flex-between mb-2">
                <span>API Gateway</span>
                <span class="status active">Online</span>
              </div>
              <div class="flex flex-between mb-2">
                <span>Document Processing</span>
                <span class="status active">Operational</span>
              </div>
              <div class="flex flex-between mb-2">
                <span>Council Integrations</span>
                <span class="status active">47 Connected</span>
              </div>
              <div class="flex flex-between">
                <span>AI Processing</span>
                <span class="status active">Ready</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="panel">
          <h2>Recent Matters</h2>
          <table class="table">
            <thead>
              <tr>
                <th>Matter Ref</th>
                <th>Property Address</th>
                <th>Council</th>
                <th>Status</th>
                <th>Assigned To</th>
                <th>Due Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>DOM-2025-001</td>
                <td>123 High Street, Hertford</td>
                <td>East Hertfordshire DC</td>
                <td><span class="status active">In Progress</span></td>
                <td>Sarah Johnson</td>
                <td>15 Sep 2025</td>
                <td><button class="btn sm">View</button></td>
              </tr>
              <tr>
                <td>DOM-2025-002</td>
                <td>45 Mill Lane, Ware</td>
                <td>East Hertfordshire DC</td>
                <td><span class="status pending">Pending Review</span></td>
                <td>Mike Chen</td>
                <td>18 Sep 2025</td>
                <td><button class="btn sm">Review</button></td>
              </tr>
              <tr>
                <td>DOM-2025-003</td>
                <td>78 Castle Street, Hertford</td>
                <td>East Hertfordshire DC</td>
                <td><span class="status draft">Draft</span></td>
                <td>Emma Wilson</td>
                <td>20 Sep 2025</td>
                <td><button class="btn sm">Edit</button></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Matters Management Page with Property Search Integration -->
      <div id="matters" class="page">
        <div class="page-header">
          <h1 class="page-title">Active Matters & Property Intelligence</h1>
          <p class="page-subtitle">Track and manage all active conveyancing matters with integrated property searches</p>
        </div>

        <!-- Performance Metrics -->
        <div class="grid grid-4">
          <div class="stat-card">
            <div class="value">247</div>
            <div class="label">Active Matters</div>
            <div class="trend up">↗ +12 this week</div>
          </div>
          <div class="stat-card">
            <div class="value text-warning">23</div>
            <div class="label">Urgent Reviews</div>
            <div class="trend down">↘ -5 resolved</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">89%</div>
            <div class="label">On Schedule</div>
            <div class="trend up">↗ +3% improvement</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">£1.2M</div>
            <div class="label">Total Portfolio Value</div>
            <div class="trend up">↗ +8% monthly</div>
          </div>
        </div>

        <!-- Property Search Tools -->
        <div class="panel">
          <h2>Integrated Property Search Tools</h2>
          <div class="grid grid-3">
            <div>
              <h3>Land Registry Integration</h3>
              <div class="form-group">
                <label>Property Search</label>
                <input type="text" placeholder="Enter postcode or address..." id="property-search">
              </div>
              <div class="flex gap-2">
                <button class="btn primary" onclick="searchProperty()">Search Property</button>
                <button class="btn" onclick="titleRegister()">Title Register</button>
              </div>
            </div>

            <div>
              <h3>Local Authority Searches</h3>
              <div class="form-group">
                <label>Search Types</label>
                <div style="display: grid; gap: 4px;">
                  <label><input type="checkbox" checked> CON29 Standard</label>
                  <label><input type="checkbox" checked> CON29O Optional</label>
                  <label><input type="checkbox"> LLC1 Local Search</label>
                  <label><input type="checkbox"> Planning History</label>
                </div>
              </div>
              <button class="btn primary">Order LA Search</button>
            </div>

            <div>
              <h3>Environmental Checks</h3>
              <div class="form-group">
                <label>Environmental Risks</label>
                <div style="display: grid; gap: 4px;">
                  <label><input type="checkbox" checked> Flood Risk</label>
                  <label><input type="checkbox" checked> Contamination</label>
                  <label><input type="checkbox"> Mining</label>
                  <label><input type="checkbox"> Radon</label>
                </div>
              </div>
              <button class="btn primary">🌍 Environmental Report</button>
            </div>
          </div>
        </div>

        <div class="grid grid-2">
          <!-- Property Intelligence Dashboard -->
          <div class="panel">
            <h2>Property Intelligence Dashboard</h2>
            <div class="form-group">
              <label>Selected Property</label>
              <div style="background: var(--bg); padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary);">
                <strong>123 High Street, Hertford, SG14 1AB</strong>
                <div class="text-muted">Freehold • 3 bed semi-detached • Built 1995</div>
              </div>
            </div>

            <div class="grid grid-2">
              <div class="stat-card">
                <div class="value text-success">£425,000</div>
                <div class="label">Estimated Value</div>
              </div>
              <div class="stat-card">
                <div class="value text-success">Low Risk</div>
                <div class="label">Overall Risk Rating</div>
              </div>
            </div>

            <div style="margin-top: 16px;">
              <h3>Available Search Results</h3>
              <div style="display: grid; gap: 8px;">
                <div class="flex flex-between flex-center" style="padding: 8px; background: var(--success); border-radius: 4px; color: white;">
                  <span>✓ Title Register</span>
                  <span class="text-sm">Completed</span>
                </div>
                <div class="flex flex-between flex-center" style="padding: 8px; background: var(--success); border-radius: 4px; color: white;">
                  <span>✓ CON29 Search</span>
                  <span class="text-sm">Completed</span>
                </div>
                <div class="flex flex-between flex-center" style="padding: 8px; background: var(--warning); border-radius: 4px;">
                  <span>⏳ Environmental Report</span>
                  <span class="text-sm">Processing</span>
                </div>
                <div class="flex flex-between flex-center" style="padding: 8px; background: var(--muted); border-radius: 4px;">
                  <span>⏸️ Mining Report</span>
                  <span class="text-sm">Not Ordered</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Search Actions -->
          <div class="panel">
            <h2>⚡ Quick Search Actions</h2>
            
            <div style="margin-bottom: 16px;">
              <h3>Bulk Search Orders</h3>
              <div class="form-group">
                <label>Select Matters for Bulk Search</label>
                <select multiple style="height: 100px;">
                  <option selected>DOM-2025-001 - 123 High Street</option>
                  <option selected>DOM-2025-002 - 45 Mill Lane</option>
                  <option>DOM-2025-003 - 78 Castle Street</option>
                </select>
              </div>
              <button class="btn primary">📦 Bulk Order Searches</button>
            </div>

            <div style="border-top: 1px solid var(--line); padding-top: 16px;">
              <h3>Search Templates</h3>
              <div class="flex gap-2" style="flex-wrap: wrap;">
                <button class="btn sm">Standard Package</button>
                <button class="btn sm">Premium Package</button>
                <button class="btn sm">Leasehold Package</button>
                <button class="btn sm">Commercial Package</button>
              </div>
            </div>

            <div style="border-top: 1px solid var(--line); padding-top: 16px;">
              <h3>Auto-Processing Rules</h3>
              <div style="display: grid; gap: 4px;">
                <label><input type="checkbox" checked> Auto-order CON29 on new matter</label>
                <label><input type="checkbox" checked> Auto-flag high-risk properties</label>
                <label><input type="checkbox"> Auto-send reports to clients</label>
                <label><input type="checkbox"> Auto-update matter timeline</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Matters Management -->
        <div class="panel">
          <div class="flex flex-between flex-center mb-4">
            <h2 class="mb-0">Active Matters with Search Status</h2>
            <button class="btn primary" onclick="showCreateMatterModal()">+ Create New Matter</button>
          </div>
          
          <!-- Advanced Filtering -->
          <div class="grid grid-4">
            <div class="form-group">
              <label>Filter by Status</label>
              <select>
                <option>All Status</option>
                <option>Searches Complete</option>
                <option>Searches Pending</option>
                <option>High Risk Properties</option>
                <option>Ready for Exchange</option>
              </select>
            </div>
            <div class="form-group">
              <label>Search Status</label>
              <select>
                <option>All Search Status</option>
                <option>Complete</option>
                <option>Pending</option>
                <option>Issues Found</option>
                <option>Not Ordered</option>
              </select>
            </div>
            <div class="form-group">
              <label>Risk Level</label>
              <select>
                <option>All Risk Levels</option>
                <option>Low Risk</option>
                <option>Medium Risk</option>
                <option>High Risk</option>
              </select>
            </div>
            <div class="form-group">
              <label>Property Search</label>
              <input type="text" placeholder="Search by address, postcode, or reference">
            </div>
          </div>
        </div>

        <!-- Enhanced Matters List -->
        <div class="panel">
          <table class="table">
            <thead>
              <tr>
                <th>Matter Ref</th>
                <th>Property Details</th>
                <th>Client</th>
                <th>Search Status</th>
                <th>Risk Level</th>
                <th>Property Value</th>
                <th>Target Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>DOM-2025-001</strong></td>
                <td>
                  <div><strong>123 High Street</strong></div>
                  <div class="text-muted text-sm">Hertford, SG14 1AB • Freehold</div>
                  <div class="text-muted text-sm">3 bed semi-detached</div>
                </td>
                <td>
                  <div>Sarah Johnson</div>
                  <div class="text-muted text-sm">East Hertfordshire DC</div>
                </td>
                <td>
                  <span class="status active">✓ Complete</span>
                  <div class="text-sm">5/5 searches done</div>
                </td>
                <td><span class="status success">Low Risk</span></td>
                <td>£425,000</td>
                <td>15 Sep 2025</td>
                <td>
                  <button class="btn sm">View</button>
                  <button class="btn sm">Searches</button>
                </td>
              </tr>
              <tr>
                <td><strong>DOM-2025-002</strong></td>
                <td>
                  <div><strong>45 Mill Lane</strong></div>
                  <div class="text-muted text-sm">Ware, SG12 9QX • Leasehold</div>
                  <div class="text-muted text-sm">2 bed flat</div>
                </td>
                <td>
                  <div>Michael Brown</div>
                  <div class="text-muted text-sm">East Hertfordshire DC</div>
                </td>
                <td>
                  <span class="status warning">⏳ Pending</span>
                  <div class="text-sm">3/6 searches done</div>
                </td>
                <td><span class="status warning">Medium Risk</span></td>
                <td>£385,000</td>
                <td>30 Sep 2025</td>
                <td>
                  <button class="btn sm">View</button>
                  <button class="btn sm">Order</button>
                </td>
              </tr>
              <tr>
                <td><strong>DOM-2025-003</strong></td>
                <td>
                  <div><strong>78 Castle Street</strong></div>
                  <div class="text-muted text-sm">Hertford, SG14 1HR • Freehold</div>
                  <div class="text-muted text-sm">4 bed detached</div>
                </td>
                <td>
                  <div>Emma Davis</div>
                  <div class="text-muted text-sm">East Hertfordshire DC</div>
                </td>
                <td>
                  <span class="status danger">⚠️ Issues Found</span>
                  <div class="text-sm">Flood risk identified</div>
                </td>
                <td><span class="status danger">High Risk</span></td>
                <td>£295,000</td>
                <td>2 Oct 2025</td>
                <td>
                  <button class="btn sm danger">Review</button>
                  <button class="btn sm">Report</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Document Management System -->
      <div id="documents" class="page">
        <div class="page-header">
          <h1 class="page-title">Document Management System</h1>
          <p class="page-subtitle">Complete document lifecycle: upload, versioning, templates, signatures, and generation</p>
        </div>

        <!-- Document Stats -->
        <div class="grid grid-4">
          <div class="stat-card">
            <div class="value text-success">1,247</div>
            <div class="label">Total Documents</div>
            <div class="trend up">↗ +23 this week</div>
          </div>
          <div class="stat-card">
            <div class="value text-warning">18</div>
            <div class="label">Pending Signatures</div>
            <div class="trend down">↘ -5 signed today</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">156</div>
            <div class="label">Templates Available</div>
            <div class="trend up">↗ +8 new templates</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">94%</div>
            <div class="label">Auto-Processing Success</div>
            <div class="trend up">↗ +2% improvement</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="panel">
          <h2>🚀 Quick Actions</h2>
          <div class="flex gap-3">
            <button class="btn primary" onclick="uploadDocuments()">� Upload Documents</button>
            <button class="btn" onclick="createTemplate()">Create Template</button>
            <button class="btn" onclick="generateDocument()">⚡ Generate Document</button>
            <button class="btn" onclick="requestSignature()">✍️ Request Signature</button>
            <button class="btn" onclick="bulkProcess()">🔄 Bulk Process</button>
          </div>
        </div>

        <!-- Document Upload & AI Processing -->
        <div class="grid grid-2">
          <div class="panel">
            <h2>AI-Powered Document Upload</h2>
            <div class="form-group">
              <label>Matter Reference</label>
              <select id="matter-select">
                <option>Select existing matter...</option>
                <option>DOM-2025-001 - 123 High Street</option>
                <option>DOM-2025-002 - 45 Mill Lane</option>
                <option>DOM-2025-003 - 78 Castle Street</option>
                <option>Create new matter...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Document Type (AI Auto-Detection)</label>
              <select id="doc-type">
                <option>Auto-Detect with AI</option>
                <option>Local Search (LLC1)</option>
                <option>Environmental Search (CON29)</option>
                <option>Planning Documents</option>
                <option>Title Deeds</option>
                <option>Contract</option>
                <option>Completion Certificate</option>
                <option>Other</option>
              </select>
            </div>

            <!-- AI Upload Drop Zone -->
            <div class="ai-upload-zone" id="ai-upload-zone" ondrop="handleAiDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
              <div class="upload-icon">AI</div>
              <h3>AI-Enhanced Document Upload</h3>
              <p>Drop documents here for instant AI analysis including:</p>
              <ul class="ai-features">
                <li>🔍 Automatic text extraction & OCR</li>
                <li>🏠 Property address detection</li>
                <li>⚠️ Risk assessment & scoring</li>
                <li>📊 Timeline & cost predictions</li>
                <li>🗺️ Property mapping integration</li>
                <li>📝 Intelligent document summary</li>
              </ul>
              <input type="file" id="ai-file-input" multiple accept=".pdf,.doc,.docx" style="display: none;" onchange="processAiFiles(this.files)">
              <button class="btn primary" onclick="document.getElementById('ai-file-input').click()">
                Choose Files for AI Analysis
              </button>
            </div>

            <!-- AI Processing Status -->
            <div class="ai-processing" id="ai-processing" style="display: none;">
              <div class="processing-header">
                <div class="processing-icon">AI</div>
                <div>
                  <h4>AI Analysis in Progress</h4>
                  <p id="processing-status">Extracting text and analyzing content...</p>
                </div>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <div class="processing-steps" id="processing-steps"></div>
            </div>
          </div>

          <!-- AI Analysis Results Panel -->
          <div class="panel" id="ai-results-panel" style="display: none;">
            <h2>AI Analysis Results</h2>
            <div class="ai-results-tabs">
              <button class="tab-btn active" onclick="showAiTab('summary')">📝 Summary</button>
              <button class="tab-btn" onclick="showAiTab('risks')">⚠️ Risk Analysis</button>
              <button class="tab-btn" onclick="showAiTab('timeline')">⏱️ Timeline</button>
              <button class="tab-btn" onclick="showAiTab('mapping')">Property Map</button>
            </div>

            <div class="ai-tab-content" id="ai-tab-summary">
              <div class="summary-content" id="summary-content"></div>
            </div>

            <div class="ai-tab-content" id="ai-tab-risks" style="display: none;">
              <div class="risk-assessment" id="risk-assessment"></div>
            </div>

            <div class="ai-tab-content" id="ai-tab-timeline" style="display: none;">
              <div class="timeline-prediction" id="timeline-prediction"></div>
            </div>

            <div class="ai-tab-content" id="ai-tab-mapping" style="display: none;">
              <div class="property-map-container">
                <div id="property-map" class="property-map"></div>
                <div class="map-info" id="map-info"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Property Details Form -->
        <div class="panel">
          <h2>Property Information</h2>
          <div class="grid grid-2">
            <div class="form-group">
              <label>Council/Authority</label>
              <input type="text" id="authority" placeholder="e.g., East Hertfordshire District Council">
            </div>

            <div>
              <div class="form-group">
                <label>Property Address</label>
                <input type="text" placeholder="Full property address">
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Postcode</label>
                  <input type="text" placeholder="e.g., SG14 1AB">
                </div>
                <div class="form-group">
                  <label>UPRN (Optional)</label>
                  <input type="text" placeholder="Unique Property Reference">
                </div>
              </div>

              <div class="form-group">
                <label>Files</label>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                  <input type="file" id="fileInput" style="display: none;" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" onchange="handleFileUpload(event)">
                  <div class="upload-icon">📁</div>
                  <h3>Drop files here or click to upload</h3>
                  <p>AI will automatically analyze and extract key information</p>
                  <small>Supported: PDF, Word, Images • Max 50MB per file</small>
                </div>
              </div>
            </div>
          </div>

          <div class="flex gap-3 mb-0">
            <button class="btn primary">Process Documents</button>
            <button class="btn">Save as Draft</button>
          </div>
        </div>

        <!-- Processing Status -->
        <div class="panel">
          <h2>🔄 Processing Queue</h2>
          <table class="table">
            <thead>
              <tr>
                <th>File</th>
                <th>Matter</th>
                <th>Type</th>
                <th>Status</th>
                <th>Progress</th>
                <th>AI Confidence</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>search_123_high_st.pdf</td>
                <td>DOM-2025-001</td>
                <td>Local Search</td>
                <td><span class="status active">Processing</span></td>
                <td>85%</td>
                <td>92%</td>
                <td><button class="btn sm">View Results</button></td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- AI Demo Panel -->
        <div class="panel">
          <h2>🤖 AI Features Demo</h2>
          <p>Experience the power of AI-driven document analysis and property mapping.</p>
          <div class="flex gap-3">
            <button onclick="demonstrateAIFeatures()" class="btn primary">🧠 Demo AI Analysis</button>
            <button onclick="showPropertyMap('15 High Street, Bishop\'s Stortford', {lat: 51.8712, lng: 0.1602})" class="btn">📍 View Property Map</button>
            <button onclick="toggleHelpbot()" class="btn">🤖 Open AI Assistant</button>
          </div>
          <small style="display: block; margin-top: 10px; color: #888;">
            🎯 Try the demo to see AI document analysis, property mapping, and intelligent assistance in action!
          </small>
        </div>
      </div>

      <!-- Calendar & Task Management -->
      <div id="calendar" class="page">
        <div class="page-header">
          <h1 class="page-title">Calendar & Task Management</h1>
          <p class="page-subtitle">Integrated scheduling, deadline tracking, and workload management</p>
        </div>

        <!-- Task Stats -->
        <div class="grid grid-4">
          <div class="stat-card">
            <div class="value text-warning">34</div>
            <div class="label">Tasks Due Today</div>
            <div class="trend up">↗ 8 completed</div>
          </div>
          <div class="stat-card">
            <div class="value text-danger">12</div>
            <div class="label">Overdue Items</div>
            <div class="trend down">↘ -3 resolved</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">89%</div>
            <div class="label">On-Time Completion</div>
            <div class="trend up">↗ +5% this month</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">2.1 days</div>
            <div class="label">Avg Task Duration</div>
            <div class="trend up">↗ 15% faster</div>
          </div>
        </div>

        <div class="grid grid-2">
          <!-- Calendar View -->
          <div class="panel">
            <h2>📅 Calendar Overview</h2>
            <div style="background: var(--bg); padding: 20px; border-radius: 8px; margin: 16px 0;">
              <div class="text-center text-muted">
                <div style="font-size: 24px; margin-bottom: 8px;">September 2025</div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 16px;">
                  <div style="padding: 8px; background: var(--panel); border-radius: 4px; text-align: center;">Mo</div>
                  <div style="padding: 8px; background: var(--panel); border-radius: 4px; text-align: center;">Tu</div>
                  <div style="padding: 8px; background: var(--panel); border-radius: 4px; text-align: center;">We</div>
                  <div style="padding: 8px; background: var(--panel); border-radius: 4px; text-align: center;">Th</div>
                  <div style="padding: 8px; background: var(--panel); border-radius: 4px; text-align: center;">Fr</div>
                  <div style="padding: 8px; background: var(--panel); border-radius: 4px; text-align: center;">Sa</div>
                  <div style="padding: 8px; background: var(--panel); border-radius: 4px; text-align: center;">Su</div>
                  <div style="padding: 8px; text-align: center;">9</div>
                  <div style="padding: 8px; text-align: center;">10</div>
                  <div style="padding: 8px; text-align: center;">11</div>
                  <div style="padding: 8px; background: var(--success); color: white; border-radius: 4px; text-align: center; font-weight: bold;">12</div>
                  <div style="padding: 8px; text-align: center;">13</div>
                  <div style="padding: 8px; background: var(--warning); color: white; border-radius: 4px; text-align: center;">14</div>
                  <div style="padding: 8px; background: var(--danger); color: white; border-radius: 4px; text-align: center;">15</div>
                </div>
                <div style="margin-top: 16px; font-size: 12px;">
                  <span style="background: var(--success); color: white; padding: 4px 8px; border-radius: 4px; margin-right: 8px;">Today</span>
                  <span style="background: var(--warning); color: white; padding: 4px 8px; border-radius: 4px; margin-right: 8px;">Deadline</span>
                  <span style="background: var(--danger); color: white; padding: 4px 8px; border-radius: 4px;">Overdue</span>
                </div>
              </div>
            </div>
            <button class="btn primary">📝 Schedule New Task</button>
          </div>

          <!-- Today's Tasks -->
          <div class="panel">
            <h2>Today's Tasks</h2>
            <div class="today-tasks" style="max-height: 400px; overflow-y: auto;">
              <div style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                <div class="flex flex-between flex-center mb-2">
                  <strong>Review LLC1 - 123 High Street</strong>
                  <span class="status pending">Due Today</span>
                </div>
                <div class="text-muted text-sm">Matter: DOM-2025-001 • Assigned: Sarah Johnson</div>
                <div class="flex gap-2" style="margin-top: 12px;">
                  <button class="btn sm success">✓ Complete</button>
                  <button class="btn sm">Extend Deadline</button>
                </div>
              </div>
              
              <div style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                <div class="flex flex-between flex-center mb-2">
                  <strong>Upload Environmental Report</strong>
                  <span class="status active">In Progress</span>
                </div>
                <div class="text-muted text-sm">Matter: DOM-2025-002 • Assigned: Mike Chen</div>
                <div class="flex gap-2" style="margin-top: 12px;">
                  <button class="btn sm success">✓ Complete</button>
                  <button class="btn sm">View Details</button>
                </div>
              </div>

              <div style="border: 1px solid var(--danger); border-radius: 8px; padding: 16px; margin-bottom: 12px; background: rgba(239, 68, 68, 0.1);">
                <div class="flex flex-between flex-center mb-2">
                  <strong>Final Report - Castle Street</strong>
                  <span class="status" style="background: var(--danger); color: white;">Overdue</span>
                </div>
                <div class="text-muted text-sm">Matter: DOM-2025-003 • Assigned: Emma Wilson</div>
                <div class="flex gap-2" style="margin-top: 12px;">
                  <button class="btn sm success">✓ Complete</button>
                  <button class="btn sm danger">Escalate</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Task Management Tools -->
        <div class="panel">
          <h2>⚡ Task Management Tools</h2>
          <div class="grid grid-3">
            <div>
              <h3>Create Task</h3>
              <div class="form-group">
                <label>Task Title</label>
                <input type="text" placeholder="Enter task description">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Assign To</label>
                  <select>
                    <option>Sarah Johnson</option>
                    <option>Mike Chen</option>
                    <option>Emma Wilson</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Priority</label>
                  <select>
                    <option>Normal</option>
                    <option>High</option>
                    <option>Critical</option>
                  </select>
                </div>
              </div>
              <button class="btn primary">Create Task</button>
            </div>

            <div>
              <h3>🔔 Auto Reminders</h3>
              <div class="form-group">
                <label>
                  <input type="checkbox" checked> Email reminders
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" checked> Deadline alerts
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox"> SMS notifications
                </label>
              </div>
              <button class="btn">Update Settings</button>
            </div>

            <div>
              <h3>📊 Workload Analytics</h3>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">127</div>
                <div class="label">Tasks This Month</div>
              </div>
              <div class="stat-card">
                <div class="value text-success">94%</div>
                <div class="label">Completion Rate</div>
              </div>
              <button class="btn" onclick="showPage('reports')">View Full Report</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Communications Hub -->
      <div id="communications" class="page">
        <div class="page-header">
          <h1 class="page-title">Communications Hub</h1>
          <p class="page-subtitle">Messaging, email integration, notifications, and client portals</p>
        </div>

        <!-- Communication Stats -->
        <div class="grid grid-4">
          <div class="stat-card">
            <div class="value text-success">156</div>
            <div class="label">Messages Today</div>
            <div class="trend up">↗ +23 vs yesterday</div>
          </div>
          <div class="stat-card">
            <div class="value text-warning">7</div>
            <div class="label">Unread Messages</div>
            <div class="trend down">↘ -12 replied</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">89%</div>
            <div class="label">Client Satisfaction</div>
            <div class="trend up">↗ +3% this month</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">2.3 hrs</div>
            <div class="label">Avg Response Time</div>
            <div class="trend up">↗ 40% faster</div>
          </div>
        </div>

        <div class="grid grid-2">
          <!-- Message Center -->
          <div class="panel">
            <h2>💬 Message Center</h2>
            <div class="flex gap-3 mb-4">
              <button class="btn primary">📝 New Message</button>
              <button class="btn">📧 Email Templates</button>
              <button class="btn">📱 SMS Broadcast</button>
            </div>

            <div style="max-height: 350px; overflow-y: auto;">
              <div style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                <div class="flex flex-between flex-center mb-2">
                  <strong>Client: John Smith (DOM-2025-001)</strong>
                  <span class="text-muted text-sm">2 hours ago</span>
                </div>
                <div class="text-muted text-sm mb-2">Re: Local search for 123 High Street</div>
                <p style="margin: 8px 0;">Could you provide an update on the progress of our local search? We're hoping to exchange contracts next week...</p>
                <div class="flex gap-2">
                  <button class="btn sm primary">Reply</button>
                  <button class="btn sm">Auto-Update</button>
                </div>
              </div>

              <div style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                <div class="flex flex-between flex-center mb-2">
                  <strong>Internal: Sarah Johnson</strong>
                  <span class="text-muted text-sm">4 hours ago</span>
                </div>
                <div class="text-muted text-sm mb-2">Re: Planning permission query - Castle Street</div>
                <p style="margin: 8px 0;">I've received the planning documents from the council. The application shows approved extensions...</p>
                <div class="flex gap-2">
                  <button class="btn sm primary">Reply</button>
                  <button class="btn sm">Forward</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Notification Center -->
          <div class="panel">
            <h2>🔔 Notification Center</h2>
            <div class="form-group">
              <label>Notification Preferences</label>
              <div style="display: grid; gap: 8px;">
                <label><input type="checkbox" checked> Email notifications</label>
                <label><input type="checkbox" checked> SMS alerts</label>
                <label><input type="checkbox" checked> Browser notifications</label>
                <label><input type="checkbox"> Slack integration</label>
                <label><input type="checkbox"> Teams integration</label>
              </div>
            </div>

            <div style="border-top: 1px solid var(--line); padding-top: 16px; margin-top: 16px;">
              <h3>Recent Notifications</h3>
              <div style="max-height: 200px; overflow-y: auto;">
                <div style="padding: 8px 0; border-bottom: 1px solid var(--line);">
                  <div class="text-sm"><strong>Document Processed</strong></div>
                  <div class="text-muted text-sm">LLC1 for DOM-2025-001 completed</div>
                </div>
                <div style="padding: 8px 0; border-bottom: 1px solid var(--line);">
                  <div class="text-sm"><strong>Client Portal Access</strong></div>
                  <div class="text-muted text-sm">John Smith logged into portal</div>
                </div>
                <div style="padding: 8px 0; border-bottom: 1px solid var(--line);">
                  <div class="text-sm"><strong>Payment Received</strong></div>
                  <div class="text-muted text-sm">£125.00 for DOM-2025-001</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Client Portal Management -->
        <div class="panel">
          <h2>🌐 Client Portal Management</h2>
          <div class="grid grid-3">
            <div>
              <h3>Portal Access</h3>
              <table class="table">
                <thead>
                  <tr><th>Client</th><th>Last Login</th><th>Status</th></tr>
                </thead>
                <tbody>
                  <tr>
                    <td>John Smith</td>
                    <td>2 hours ago</td>
                    <td><span class="status active">Active</span></td>
                  </tr>
                  <tr>
                    <td>Jane Doe</td>
                    <td>1 day ago</td>
                    <td><span class="status active">Active</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div>
              <h3>Portal Features</h3>
              <div style="display: grid; gap: 8px;">
                <label><input type="checkbox" checked> Document download</label>
                <label><input type="checkbox" checked> Progress tracking</label>
                <label><input type="checkbox" checked> Payment processing</label>
                <label><input type="checkbox"> Live chat</label>
                <label><input type="checkbox"> Appointment booking</label>
              </div>
              <button class="btn primary" style="margin-top: 12px;">Update Portal</button>
            </div>

            <div>
              <h3>Branded Portals</h3>
              <div class="form-group">
                <label>Council Branding</label>
                <select>
                  <option>East Hertfordshire DC</option>
                  <option>Standard Template</option>
                  <option>Custom Branding</option>
                </select>
              </div>
              <button class="btn">Customize Portal</button>
            </div>
          </div>
        </div>
      </div>

      <!-- User Management Page -->
      <div id="users" class="page">
        <div class="page-header">
          <h1 class="page-title">User Management</h1>
          <p class="page-subtitle">Manage staff accounts and permissions</p>
        </div>

        <div class="panel">
          <div class="flex flex-between flex-center mb-4">
            <h2 class="mb-0">Council Staff</h2>
            <button class="btn primary">+ Add New User</button>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Department</th>
                <th>Role</th>
                <th>Last Login</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Sarah Johnson</strong></td>
                <td>s.johnson@eastherts.gov.uk</td>
                <td>Planning</td>
                <td>Senior Officer</td>
                <td>2 hours ago</td>
                <td><span class="status active">Active</span></td>
                <td>
                  <button class="btn sm">Edit</button>
                  <button class="btn sm">Permissions</button>
                </td>
              </tr>
              <tr>
                <td><strong>Mike Chen</strong></td>
                <td>m.chen@eastherts.gov.uk</td>
                <td>Housing</td>
                <td>Officer</td>
                <td>1 day ago</td>
                <td><span class="status active">Active</span></td>
                <td>
                  <button class="btn sm">Edit</button>
                  <button class="btn sm">Permissions</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Financial Management Suite -->
      <div id="billing" class="page">
        <div class="page-header">
          <h1 class="page-title">Financial Management Suite</h1>
          <p class="page-subtitle">Advanced invoicing, payment processing, cost tracking, and financial forecasting</p>
        </div>

        <!-- Financial Overview -->
        <div class="grid grid-4">
          <div class="stat-card">
            <div class="value text-success">£28,450</div>
            <div class="label">Monthly Revenue</div>
            <div class="trend up">↗ +18% vs last month</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">£186,250</div>
            <div class="label">Year to Date</div>
            <div class="trend up">↗ +24% vs last year</div>
          </div>
          <div class="stat-card">
            <div class="value text-warning">£4,125</div>
            <div class="label">Outstanding Invoices</div>
            <div class="trend down">↘ -15% improvement</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">£125.50</div>
            <div class="label">Avg Cost per Matter</div>
            <div class="trend up">↗ +8% efficiency</div>
          </div>
        </div>

        <!-- Financial Tools -->
        <div class="panel">
          <h2>💼 Financial Management Tools</h2>
          <div class="flex gap-3">
            <button class="btn primary" onclick="generateInvoice()">📄 Generate Invoice</button>
            <button class="btn" onclick="processPayment()">💳 Process Payment</button>
            <button class="btn" onclick="costAnalysis()">📊 Cost Analysis</button>
            <button class="btn" onclick="financialForecast()">📈 Financial Forecast</button>
            <button class="btn" onclick="exportFinancials()">📤 Export Data</button>
          </div>
        </div>

        <div class="grid grid-2">
          <!-- Invoicing & Billing -->
          <div class="panel">
            <h2>Advanced Invoicing</h2>
            <div class="form-group">
              <label>Invoice Template</label>
              <select id="invoice-template">
                <option>East Hertfordshire Council</option>
                <option>Planning Department</option>
                <option>Housing Department</option>
                <option>Custom Template</option>
              </select>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Billing Period</label>
                <select>
                  <option>September 2025</option>
                  <option>August 2025</option>
                  <option>Custom Range</option>
                </select>
              </div>
              <div class="form-group">
                <label>Department</label>
                <select>
                  <option>All Departments</option>
                  <option>Planning</option>
                  <option>Housing</option>
                  <option>Legal</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Invoice Items</label>
              <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin: 8px 0;">
                <div class="flex flex-between flex-center">
                  <span>Local Searches (47 items)</span>
                  <span>£5,875.00</span>
                </div>
              </div>
              <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin: 8px 0;">
                <div class="flex flex-between flex-center">
                  <span>Environmental Searches (23 items)</span>
                  <span>£2,185.00</span>
                </div>
              </div>
              <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin: 8px 0;">
                <div class="flex flex-between flex-center">
                  <span>Planning Searches (31 items)</span>
                  <span>£4,650.00</span>
                </div>
              </div>
            </div>

            <div class="flex flex-between flex-center" style="padding-top: 12px; border-top: 1px solid var(--line);">
              <strong>Total</strong>
              <strong>£12,710.00</strong>
            </div>

            <div class="flex gap-2" style="margin-top: 16px;">
              <button class="btn primary">Generate Invoice</button>
              <button class="btn">Save Draft</button>
            </div>
          </div>

          <!-- Payment Processing -->
          <div class="panel">
            <h2>� Payment Processing</h2>
            <div class="grid grid-2">
              <div class="stat-card">
                <div class="value text-success">£18,420</div>
                <div class="label">Payments This Month</div>
              </div>
              <div class="stat-card">
                <div class="value text-success">97%</div>
                <div class="label">Collection Rate</div>
              </div>
            </div>

            <div style="margin: 16px 0;">
              <h3>Payment Methods</h3>
              <div style="display: grid; gap: 8px;">
                <label><input type="checkbox" checked> Bank Transfer (BACS)</label>
                <label><input type="checkbox" checked> Card Payments</label>
                <label><input type="checkbox" checked> Direct Debit</label>
                <label><input type="checkbox"> PayPal</label>
                <label><input type="checkbox"> Stripe</label>
              </div>
            </div>

            <div style="border-top: 1px solid var(--line); padding-top: 16px;">
              <h3>Recent Payments</h3>
              <div style="max-height: 150px; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--line);">
                  <div>
                    <div class="text-sm">DOM-2025-001</div>
                    <div class="text-muted text-sm">Card Payment</div>
                  </div>
                  <div class="text-success">+£125.00</div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--line);">
                  <div>
                    <div class="text-sm">DOM-2025-002</div>
                    <div class="text-muted text-sm">Bank Transfer</div>
                  </div>
                  <div class="text-success">+£95.00</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cost Tracking & Budget Management -->
        <div class="panel">
          <h2>📊 Cost Tracking & Budget Management</h2>
          <div class="grid grid-3">
            <div>
              <h3>Department Budgets</h3>
              <div style="margin: 12px 0;">
                <div class="flex flex-between flex-center mb-2">
                  <span>Planning Department</span>
                  <span>£15,000 / £18,000</span>
                </div>
                <div style="background: var(--bg); border-radius: 8px; overflow: hidden;">
                  <div style="background: var(--success); height: 8px; width: 83%;"></div>
                </div>
              </div>
              
              <div style="margin: 12px 0;">
                <div class="flex flex-between flex-center mb-2">
                  <span>Housing Department</span>
                  <span>£8,500 / £12,000</span>
                </div>
                <div style="background: var(--bg); border-radius: 8px; overflow: hidden;">
                  <div style="background: var(--warning); height: 8px; width: 71%;"></div>
                </div>
              </div>

              <div style="margin: 12px 0;">
                <div class="flex flex-between flex-center mb-2">
                  <span>Legal Department</span>
                  <span>£11,200 / £10,000</span>
                </div>
                <div style="background: var(--bg); border-radius: 8px; overflow: hidden;">
                  <div style="background: var(--danger); height: 8px; width: 100%;"></div>
                </div>
              </div>
            </div>

            <div>
              <h3>Cost Analysis</h3>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">£89.50</div>
                <div class="label">Avg Cost per Search</div>
              </div>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">£2,840</div>
                <div class="label">Monthly Savings</div>
              </div>
              <button class="btn">View Detailed Analysis</button>
            </div>

            <div>
              <h3>Financial Forecasting</h3>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">£34,200</div>
                <div class="label">Projected Next Month</div>
              </div>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">£245,000</div>
                <div class="label">Yearly Projection</div>
              </div>
              <button class="btn primary">Generate Forecast</button>
            </div>
          </div>
        </div>

        <!-- Recent Invoices & Transactions -->
        <div class="panel">
          <h2>�💰 Recent Invoices & Transactions</h2>
          <table class="table">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Department</th>
                <th>Period</th>
                <th>Items</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Due Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>INV-2025-091</strong></td>
                <td>Planning</td>
                <td>Sep 2025</td>
                <td>47 searches</td>
                <td>£5,875.00</td>
                <td><span class="status pending">Pending</span></td>
                <td>30 Sep 2025</td>
                <td>
                  <button class="btn sm">View</button>
                  <button class="btn sm">Send</button>
                </td>
              </tr>
              <tr>
                <td><strong>INV-2025-090</strong></td>
                <td>Housing</td>
                <td>Aug 2025</td>
                <td>23 searches</td>
                <td>£2,185.00</td>
                <td><span class="status active">Paid</span></td>
                <td>31 Aug 2025</td>
                <td>
                  <button class="btn sm">Download PDF</button>
                  <button class="btn sm">Receipt</button>
                </td>
              </tr>
              <tr>
                <td><strong>INV-2025-089</strong></td>
                <td>Legal</td>
                <td>Aug 2025</td>
                <td>31 searches</td>
                <td>£4,650.00</td>
                <td><span class="status active">Paid</span></td>
                <td>31 Aug 2025</td>
                <td>
                  <button class="btn sm">Download PDF</button>
                  <button class="btn sm">Receipt</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- System Integrations Page -->
      <div id="integrations" class="page">
        <div class="page-header">
          <h1 class="page-title">System Integrations</h1>
          <p class="page-subtitle">Connected systems and data sources</p>
        </div>

        <div class="panel">
          <h2>🔗 Council Systems</h2>
          <div class="grid grid-3">
            <div class="stat-card">
              <div class="flex flex-between flex-center">
                <div>
                  <div class="fw-600">Capita Academy</div>
                  <div class="text-sm text-muted">CRM Integration</div>
                </div>
                <span class="status active">Connected</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="flex flex-between flex-center">
                <div>
                  <div class="fw-600">Civica CX</div>
                  <div class="text-sm text-muted">Finance System</div>
                </div>
                <span class="status active">Connected</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="flex flex-between flex-center">
                <div>
                  <div class="fw-600">SharePoint</div>
                  <div class="text-sm text-muted">Document Storage</div>
                </div>
                <span class="status pending">Pending</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Reports & Analytics Page -->
      <div id="reports" class="page">
        <div class="page-header">
          <h1 class="page-title">Advanced Reports & Analytics</h1>
          <p class="page-subtitle">Performance dashboards, financial reports, workflow analytics, and custom report builder</p>
        </div>

        <!-- Executive Dashboard -->
        <div class="grid grid-4">
          <div class="stat-card">
            <div class="value text-success">£1.2M</div>
            <div class="label">Monthly Revenue</div>
            <div class="trend up">↗ +24% vs last month</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">2,847</div>
            <div class="label">Searches Completed</div>
            <div class="trend up">↗ +18% efficiency gain</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">94%</div>
            <div class="label">Client Satisfaction</div>
            <div class="trend up">↗ +2% improvement</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">1.8 days</div>
            <div class="label">Avg Processing Time</div>
            <div class="trend up">↗ 42% faster</div>
          </div>
        </div>

        <!-- Report Generation Tools -->
        <div class="panel">
          <h2>📊 Report Generation & Export</h2>
          <div class="grid grid-4">
            <button class="btn primary" onclick="generatePerformanceReport()">📈 Performance Report</button>
            <button class="btn primary" onclick="generateFinancialReport()">💰 Financial Report</button>
            <button class="btn primary" onclick="generateWorkflowReport()">⚡ Workflow Analytics</button>
            <button class="btn primary" onclick="customReportBuilder()">🔧 Custom Report Builder</button>
          </div>
        </div>

        <div class="grid grid-2">
          <!-- Performance Analytics -->
          <div class="panel">
            <h2>📈 Performance Analytics Dashboard</h2>
            
            <div style="margin-bottom: 16px;">
              <h3>Processing Performance</h3>
              <div class="grid grid-2">
                <div class="stat-card">
                  <div class="value text-success">2.3 hrs</div>
                  <div class="label">Avg Search Time</div>
                </div>
                <div class="stat-card">
                  <div class="value text-success">96%</div>
                  <div class="label">SLA Compliance</div>
                </div>
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <h3>Department Performance</h3>
              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Planning Department</span>
                  <span class="text-success">98% efficiency</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--success); height: 6px; width: 98%;"></div>
                </div>
              </div>
              
              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Housing Department</span>
                  <span class="text-success">94% efficiency</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--success); height: 6px; width: 94%;"></div>
                </div>
              </div>

              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Legal Department</span>
                  <span class="text-warning">87% efficiency</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--warning); height: 6px; width: 87%;"></div>
                </div>
              </div>
            </div>

            <div style="border-top: 1px solid var(--line); padding-top: 16px;">
              <h3>Quality Metrics</h3>
              <div class="flex flex-between mb-2">
                <span>Error Rate</span>
                <span class="text-success">0.3%</span>
              </div>
              <div class="flex flex-between mb-2">
                <span>Client Satisfaction</span>
                <span class="text-success">94%</span>
              </div>
              <div class="flex flex-between">
                <span>Repeat Business</span>
                <span class="text-success">78%</span>
              </div>
            </div>
          </div>

          <!-- Financial Analytics -->
          <div class="panel">
            <h2>💰 Financial Analytics Dashboard</h2>

            <div style="margin-bottom: 16px;">
              <h3>Revenue Breakdown</h3>
              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Local Searches</span>
                  <span>£485,200 (45%)</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--primary); height: 6px; width: 45%;"></div>
                </div>
              </div>

              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Environmental</span>
                  <span>£324,800 (30%)</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--success); height: 6px; width: 30%;"></div>
                </div>
              </div>

              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Planning</span>
                  <span>£270,000 (25%)</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--warning); height: 6px; width: 25%;"></div>
                </div>
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <h3>Profitability Analysis</h3>
              <div class="grid grid-2">
                <div class="stat-card">
                  <div class="value text-success">34%</div>
                  <div class="label">Gross Margin</div>
                </div>
                <div class="stat-card">
                  <div class="value text-success">£127</div>
                  <div class="label">Avg Order Value</div>
                </div>
              </div>
            </div>

            <div style="border-top: 1px solid var(--line); padding-top: 16px;">
              <h3>Cost Analysis</h3>
              <div class="flex flex-between mb-2">
                <span>Operational Costs</span>
                <span>£68,400</span>
              </div>
              <div class="flex flex-between mb-2">
                <span>Technology Costs</span>
                <span>£12,200</span>
              </div>
              <div class="flex flex-between">
                <span>Staff Costs</span>
                <span>£145,600</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Workflow Analytics -->
        <div class="panel">
          <h2>⚡ Workflow Analytics & Process Intelligence</h2>
          <div class="grid grid-3">
            <div>
              <h3>Process Efficiency</h3>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">89%</div>
                <div class="label">Workflow Automation</div>
              </div>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">2.1 hrs</div>
                <div class="label">Avg Task Duration</div>
              </div>
              <div class="stat-card">
                <div class="value text-warning">12</div>
                <div class="label">Bottlenecks Identified</div>
              </div>
            </div>

            <div>
              <h3>Team Productivity</h3>
              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Sarah Johnson</span>
                  <span>47 matters/month</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--success); height: 6px; width: 94%;"></div>
                </div>
              </div>

              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Mike Chen</span>
                  <span>42 matters/month</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--success); height: 6px; width: 84%;"></div>
                </div>
              </div>

              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Emma Wilson</span>
                  <span>39 matters/month</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--warning); height: 6px; width: 78%;"></div>
                </div>
              </div>
            </div>

            <div>
              <h3>Process Optimization</h3>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">42%</div>
                <div class="label">Time Saved vs Manual</div>
              </div>
              <button class="btn primary" style="width: 100%; margin-bottom: 8px;">Optimize Workflows</button>
              <button class="btn" style="width: 100%;">Export Analysis</button>
            </div>
          </div>
        </div>

        <!-- Custom Report Builder -->
        <div class="panel">
          <h2>🔧 Custom Report Builder</h2>
          <div class="grid grid-2">
            <div>
              <h3>Report Configuration</h3>
              <div class="form-group">
                <label>Report Type</label>
                <select id="report-type">
                  <option>Financial Summary</option>
                  <option>Performance Analysis</option>
                  <option>Department Breakdown</option>
                  <option>Client Activity Report</option>
                  <option>Custom Dashboard</option>
                </select>
              </div>

              <div class="form-group">
                <label>Date Range</label>
                <div class="form-row">
                  <input type="date" value="2025-08-01">
                  <input type="date" value="2025-09-30">
                </div>
              </div>

              <div class="form-group">
                <label>Departments</label>
                <div style="display: grid; gap: 4px;">
                  <label><input type="checkbox" checked> Planning</label>
                  <label><input type="checkbox" checked> Housing</label>
                  <label><input type="checkbox" checked> Legal</label>
                  <label><input type="checkbox"> All Departments</label>
                </div>
              </div>
            </div>

            <div>
              <h3>Data Metrics</h3>
              <div class="form-group">
                <label>Include Metrics</label>
                <div style="display: grid; gap: 4px;">
                  <label><input type="checkbox" checked> Revenue & Costs</label>
                  <label><input type="checkbox" checked> Processing Times</label>
                  <label><input type="checkbox" checked> Success Rates</label>
                  <label><input type="checkbox" checked> Client Satisfaction</label>
                  <label><input type="checkbox"> Workflow Efficiency</label>
                  <label><input type="checkbox"> Risk Analysis</label>
                </div>
              </div>

              <div class="form-group">
                <label>Output Format</label>
                <div class="flex gap-2">
                  <label><input type="radio" name="format" checked> PDF</label>
                  <label><input type="radio" name="format"> Excel</label>
                  <label><input type="radio" name="format"> CSV</label>
                </div>
              </div>

              <div class="flex gap-2" style="margin-top: 16px;">
                <button class="btn primary">Generate Report</button>
                <button class="btn">Save Template</button>
                <button class="btn">Preview</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Report History & Templates -->
        <div class="panel">
          <h2>📋 Recent Reports & Templates</h2>
          <table class="table">
            <thead>
              <tr>
                <th>Report Name</th>
                <th>Type</th>
                <th>Generated</th>
                <th>Size</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Monthly Performance Sept 2025</strong></td>
                <td>Performance Analysis</td>
                <td>30 Sep 2025 14:32</td>
                <td>2.4 MB</td>
                <td><span class="status active">Ready</span></td>
                <td>
                  <button class="btn sm">Download</button>
                  <button class="btn sm">Share</button>
                </td>
              </tr>
              <tr>
                <td><strong>Financial Summary Q3 2025</strong></td>
                <td>Financial Report</td>
                <td>28 Sep 2025 09:15</td>
                <td>1.8 MB</td>
                <td><span class="status active">Ready</span></td>
                <td>
                  <button class="btn sm">Download</button>
                  <button class="btn sm">Share</button>
                </td>
              </tr>
              <tr>
                <td><strong>Workflow Optimization Analysis</strong></td>
                <td>Process Intelligence</td>
                <td>25 Sep 2025 16:45</td>
                <td>3.1 MB</td>
                <td><span class="status active">Ready</span></td>
                <td>
                  <button class="btn sm">Download</button>
                  <button class="btn sm">Share</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Compliance & Audit Page -->
      <div id="compliance" class="page">
        <div class="page-header">
          <h1 class="page-title">Compliance & Audit</h1>
          <p class="page-subtitle">Security, compliance, and audit trails</p>
        </div>

        <div class="panel">
          <h2>🛡️ Compliance Status</h2>
          <div class="grid grid-2">
            <div>
              <div class="flex flex-between mb-2">
                <span>GDPR Compliance</span>
                <span class="status active">Compliant</span>
              </div>
              <div class="flex flex-between mb-2">
                <span>ISO 27001</span>
                <span class="status active">Certified</span>
              </div>
              <div class="flex flex-between">
                <span>Cyber Essentials Plus</span>
                <span class="status active">Certified</span>
              </div>
            </div>
            <div>
              <div class="flex flex-between mb-2">
                <span>Data Retention</span>
                <span class="status active">Automated</span>
              </div>
              <div class="flex flex-between mb-2">
                <span>Audit Logging</span>
                <span class="status active">Active</span>
              </div>
              <div class="flex flex-between">
                <span>Backup & Recovery</span>
                <span class="status active">99.9% SLA</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Workflow Engine -->
      <div id="workflow" class="page">
        <div class="page-header">
          <h1 class="page-title">Advanced Workflow Engine</h1>
          <p class="page-subtitle">Configurable workflows, approval chains, escalation rules, and automated task routing</p>
        </div>

        <!-- Workflow Overview -->
        <div class="grid grid-4">
          <div class="stat-card">
            <div class="value text-success">47</div>
            <div class="label">Active Workflows</div>
            <div class="trend up">↗ +8 automated processes</div>
          </div>
          <div class="stat-card">
            <div class="value text-warning">12</div>
            <div class="label">Pending Approvals</div>
            <div class="trend down">↘ -5 processed today</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">89%</div>
            <div class="label">Automation Rate</div>
            <div class="trend up">↗ +15% improvement</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">2.1 hrs</div>
            <div class="label">Avg Processing Time</div>
            <div class="trend up">↗ 45% faster</div>
          </div>
        </div>

        <!-- Workflow Builder Tools -->
        <div class="panel">
          <h2>🔧 Workflow Design & Management Tools</h2>
          <div class="flex gap-3">
            <button class="btn primary" onclick="createWorkflow()">⚡ Create Workflow</button>
            <button class="btn" onclick="workflowTemplates()">📋 Workflow Templates</button>
            <button class="btn" onclick="approvalChains()">🔗 Approval Chains</button>
            <button class="btn" onclick="escalationRules()">⚠️ Escalation Rules</button>
            <button class="btn" onclick="workflowAnalytics()">📊 Analytics</button>
          </div>
        </div>

        <div class="grid grid-2">
          <!-- Active Workflows -->
          <div class="panel">
            <h2>⚡ Active Workflows & Approval Chains</h2>
            
            <div style="margin-bottom: 16px;">
              <h3>Current Processing Queue</h3>
              <div style="display: grid; gap: 8px;">
                <div style="background: var(--bg); padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary);">
                  <div class="flex flex-between flex-center">
                    <div>
                      <strong>Local Search Approval</strong>
                      <div class="text-muted text-sm">DOM-2025-001 • Sarah Johnson → Mike Chen</div>
                    </div>
                    <span class="status warning">Pending</span>
                  </div>
                </div>

                <div style="background: var(--bg); padding: 12px; border-radius: 8px; border-left: 4px solid var(--success);">
                  <div class="flex flex-between flex-center">
                    <div>
                      <strong>Environmental Report</strong>
                      <div class="text-muted text-sm">DOM-2025-002 • Auto-processed</div>
                    </div>
                    <span class="status active">Complete</span>
                  </div>
                </div>

                <div style="background: var(--bg); padding: 12px; border-radius: 8px; border-left: 4px solid var(--warning);">
                  <div class="flex flex-between flex-center">
                    <div>
                      <strong>High Value Review</strong>
                      <div class="text-muted text-sm">DOM-2025-003 • Escalated to supervisor</div>
                    </div>
                    <span class="status danger">Urgent</span>
                  </div>
                </div>
              </div>
            </div>

            <div style="border-top: 1px solid var(--line); padding-top: 16px;">
              <h3>Workflow Performance</h3>
              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Standard Processing</span>
                  <span class="text-success">94% on-time</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--success); height: 6px; width: 94%;"></div>
                </div>
              </div>

              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Express Processing</span>
                  <span class="text-success">98% on-time</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--success); height: 6px; width: 98%;"></div>
                </div>
              </div>

              <div style="margin: 8px 0;">
                <div class="flex flex-between flex-center mb-1">
                  <span>Complex Reviews</span>
                  <span class="text-warning">87% on-time</span>
                </div>
                <div style="background: var(--bg); border-radius: 4px; overflow: hidden;">
                  <div style="background: var(--warning); height: 6px; width: 87%;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Workflow Configuration -->
          <div class="panel">
            <h2>⚙️ Workflow Configuration</h2>

            <div style="margin-bottom: 16px;">
              <h3>Approval Chain Rules</h3>
              <div class="form-group">
                <label>Workflow Type</label>
                <select id="workflow-type">
                  <option>Local Search Processing</option>
                  <option>Environmental Assessment</option>
                  <option>High-Value Matter Review</option>
                  <option>Client Communication</option>
                  <option>Document Approval</option>
                </select>
              </div>

              <div class="form-group">
                <label>Approval Chain</label>
                <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                  <div class="text-sm" style="margin-bottom: 8px;">
                    <strong>Step 1:</strong> Initial Processing → Sarah Johnson
                  </div>
                  <div class="text-sm" style="margin-bottom: 8px;">
                    <strong>Step 2:</strong> Quality Check → Mike Chen
                  </div>
                  <div class="text-sm" style="margin-bottom: 8px;">
                    <strong>Step 3:</strong> Final Approval → Emma Wilson
                  </div>
                </div>
              </div>
            </div>

            <div style="border-top: 1px solid var(--line); padding-top: 16px;">
              <h3>Escalation Rules</h3>
              <div class="form-group">
                <label>Escalation Triggers</label>
                <div style="display: grid; gap: 4px;">
                  <label><input type="checkbox" checked> 24 hours without action</label>
                  <label><input type="checkbox" checked> High priority matters</label>
                  <label><input type="checkbox" checked> Value > £500,000</label>
                  <label><input type="checkbox"> Client VIP status</label>
                </div>
              </div>

              <div class="form-group">
                <label>Escalation Actions</label>
                <div style="display: grid; gap: 4px;">
                  <label><input type="checkbox" checked> Email notification</label>
                  <label><input type="checkbox" checked> SMS alert</label>
                  <label><input type="checkbox"> Assign to supervisor</label>
                  <label><input type="checkbox"> Auto-approve if criteria met</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Workflow Templates & Automation Rules -->
        <div class="panel">
          <h2>📋 Workflow Templates & Automation Rules</h2>
          <div class="grid grid-3">
            <div>
              <h3>Standard Templates</h3>
              <div style="display: grid; gap: 8px;">
                <div style="background: var(--bg); padding: 12px; border-radius: 8px; cursor: pointer;" onclick="useTemplate('local-search')">
                  <div class="flex flex-between flex-center">
                    <div>
                      <strong>Local Search Standard</strong>
                      <div class="text-muted text-sm">3 steps • 24hr SLA</div>
                    </div>
                    <button class="btn sm">Use</button>
                  </div>
                </div>

                <div style="background: var(--bg); padding: 12px; border-radius: 8px; cursor: pointer;" onclick="useTemplate('environmental')">
                  <div class="flex flex-between flex-center">
                    <div>
                      <strong>Environmental Assessment</strong>
                      <div class="text-muted text-sm">4 steps • 48hr SLA</div>
                    </div>
                    <button class="btn sm">Use</button>
                  </div>
                </div>

                <div style="background: var(--bg); padding: 12px; border-radius: 8px; cursor: pointer;" onclick="useTemplate('high-value')">
                  <div class="flex flex-between flex-center">
                    <div>
                      <strong>High-Value Review</strong>
                      <div class="text-muted text-sm">5 steps • 12hr SLA</div>
                    </div>
                    <button class="btn sm">Use</button>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <h3>Automation Rules</h3>
              <div style="display: grid; gap: 8px;">
                <div class="flex flex-between flex-center" style="padding: 8px; background: var(--success); border-radius: 4px; color: white;">
                  <span>✓ Auto-assign by department</span>
                  <span class="text-sm">Active</span>
                </div>
                <div class="flex flex-between flex-center" style="padding: 8px; background: var(--success); border-radius: 4px; color: white;">
                  <span>✓ Priority routing</span>
                  <span class="text-sm">Active</span>
                </div>
                <div class="flex flex-between flex-center" style="padding: 8px; background: var(--warning); border-radius: 4px;">
                  <span>⏳ Smart escalation</span>
                  <span class="text-sm">Testing</span>
                </div>
                <div class="flex flex-between flex-center" style="padding: 8px; background: var(--muted); border-radius: 4px;">
                  <span>⏸️ AI task routing</span>
                  <span class="text-sm">Disabled</span>
                </div>
              </div>
              <button class="btn primary" style="width: 100%; margin-top: 8px;">Manage Rules</button>
            </div>

            <div>
              <h3>Performance Metrics</h3>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">89%</div>
                <div class="label">Workflow Efficiency</div>
              </div>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">£45,200</div>
                <div class="label">Monthly Savings</div>
              </div>
              <button class="btn" style="width: 100%;">View Analytics</button>
            </div>
          </div>
        </div>

        <!-- Current Approvals & Tasks -->
        <div class="panel">
          <h2>📋 Current Approvals & Task Queue</h2>
          <table class="table">
            <thead>
              <tr>
                <th>Task/Approval</th>
                <th>Matter</th>
                <th>Assigned To</th>
                <th>Priority</th>
                <th>Due Date</th>
                <th>Status</th>
                <th>Next Step</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <div><strong>Local Search Review</strong></div>
                  <div class="text-muted text-sm">Quality assurance check</div>
                </td>
                <td>DOM-2025-001</td>
                <td>Mike Chen</td>
                <td><span class="text-success">Standard</span></td>
                <td>2 Oct 2025</td>
                <td><span class="status warning">Pending</span></td>
                <td>Final Approval</td>
                <td>
                  <button class="btn sm">Approve</button>
                  <button class="btn sm">Review</button>
                </td>
              </tr>
              <tr>
                <td>
                  <div><strong>High-Value Assessment</strong></div>
                  <div class="text-muted text-sm">Supervisor review required</div>
                </td>
                <td>DOM-2025-003</td>
                <td>Emma Wilson</td>
                <td><span class="text-danger">High</span></td>
                <td>1 Oct 2025</td>
                <td><span class="status danger">Escalated</span></td>
                <td>Director Approval</td>
                <td>
                  <button class="btn sm danger">Urgent</button>
                  <button class="btn sm">Escalate</button>
                </td>
              </tr>
              <tr>
                <td>
                  <div><strong>Environmental Report</strong></div>
                  <div class="text-muted text-sm">Automated processing complete</div>
                </td>
                <td>DOM-2025-002</td>
                <td>System</td>
                <td><span class="text-success">Standard</span></td>
                <td>3 Oct 2025</td>
                <td><span class="status active">Auto-Complete</span></td>
                <td>Client Notification</td>
                <td>
                  <button class="btn sm">View</button>
                  <button class="btn sm">Send</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- User Management & Permissions Page -->
      <div id="settings" class="page">
        <div class="page-header">
          <h1 class="page-title">User Management & Permissions</h1>
          <p class="page-subtitle">Role-based access control, user administration, permission management, and audit trails</p>
        </div>

        <!-- User Management Overview -->
        <div class="grid grid-4">
          <div class="stat-card">
            <div class="value text-success">47</div>
            <div class="label">Active Users</div>
            <div class="trend up">↗ +3 new this month</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">8</div>
            <div class="label">User Roles</div>
            <div class="trend">• Custom RBAC system</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">156</div>
            <div class="label">Permission Rules</div>
            <div class="trend up">↗ +12 refined rules</div>
          </div>
          <div class="stat-card">
            <div class="value text-success">99.8%</div>
            <div class="label">Security Compliance</div>
            <div class="trend up">↗ Enhanced security</div>
          </div>
        </div>

        <!-- User Administration Tools -->
        <div class="panel">
          <h2>👥 User Administration Tools</h2>
          <div class="flex gap-3">
            <button class="btn primary" onclick="addUser()">👤 Add New User</button>
            <button class="btn" onclick="bulkUserImport()">📤 Bulk Import</button>
            <button class="btn" onclick="roleManagement()">🔑 Manage Roles</button>
            <button class="btn" onclick="permissionMatrix()">🛡️ Permission Matrix</button>
            <button class="btn" onclick="auditTrail()">📋 Audit Trail</button>
          </div>
        </div>

        <div class="grid grid-2">
          <!-- Role-Based Access Control -->
          <div class="panel">
            <h2>🔑 Role-Based Access Control (RBAC)</h2>
            
            <div style="margin-bottom: 16px;">
              <h3>System Roles</h3>
              <div style="display: grid; gap: 8px;">
                <div style="background: var(--bg); padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary);">
                  <div class="flex flex-between flex-center">
                    <div>
                      <strong>Super Administrator</strong>
                      <div class="text-muted text-sm">Full system access • 2 users</div>
                    </div>
                    <button class="btn sm">Edit</button>
                  </div>
                </div>

                <div style="background: var(--bg); padding: 12px; border-radius: 8px; border-left: 4px solid var(--success);">
                  <div class="flex flex-between flex-center">
                    <div>
                      <strong>Department Manager</strong>
                      <div class="text-muted text-sm">Department oversight • 8 users</div>
                    </div>
                    <button class="btn sm">Edit</button>
                  </div>
                </div>

                <div style="background: var(--bg); padding: 12px; border-radius: 8px; border-left: 4px solid var(--warning);">
                  <div class="flex flex-between flex-center">
                    <div>
                      <strong>Senior Conveyancer</strong>
                      <div class="text-muted text-sm">Advanced processing • 12 users</div>
                    </div>
                    <button class="btn sm">Edit</button>
                  </div>
                </div>

                <div style="background: var(--bg); padding: 12px; border-radius: 8px; border-left: 4px solid var(--muted);">
                  <div class="flex flex-between flex-center">
                    <div>
                      <strong>Conveyancing Officer</strong>
                      <div class="text-muted text-sm">Standard processing • 18 users</div>
                    </div>
                    <button class="btn sm">Edit</button>
                  </div>
                </div>

                <div style="background: var(--bg); padding: 12px; border-radius: 8px; border-left: 4px solid var(--muted);">
                  <div class="flex flex-between flex-center">
                    <div>
                      <strong>Read-Only User</strong>
                      <div class="text-muted text-sm">View access only • 7 users</div>
                    </div>
                    <button class="btn sm">Edit</button>
                  </div>
                </div>
              </div>
            </div>

            <div style="border-top: 1px solid var(--line); padding-top: 16px;">
              <h3>Create Custom Role</h3>
              <div class="form-group">
                <label>Role Name</label>
                <input type="text" placeholder="Enter role name...">
              </div>
              <button class="btn primary">Create Role</button>
            </div>
          </div>

          <!-- Permission Management -->
          <div class="panel">
            <h2>🛡️ Permission Management</h2>

            <div style="margin-bottom: 16px;">
              <h3>Permission Categories</h3>
              <div class="form-group">
                <label>Select Role</label>
                <select id="role-selector">
                  <option>Senior Conveyancer</option>
                  <option>Department Manager</option>
                  <option>Conveyancing Officer</option>
                  <option>Read-Only User</option>
                </select>
              </div>
            </div>

            <div style="max-height: 300px; overflow-y: auto;">
              <h3>Document Management</h3>
              <div style="display: grid; gap: 4px; margin-bottom: 16px;">
                <label><input type="checkbox" checked> View documents</label>
                <label><input type="checkbox" checked> Upload documents</label>
                <label><input type="checkbox" checked> Edit documents</label>
                <label><input type="checkbox"> Delete documents</label>
                <label><input type="checkbox"> Manage templates</label>
              </div>

              <h3>Matter Management</h3>
              <div style="display: grid; gap: 4px; margin-bottom: 16px;">
                <label><input type="checkbox" checked> View matters</label>
                <label><input type="checkbox" checked> Create matters</label>
                <label><input type="checkbox" checked> Edit matters</label>
                <label><input type="checkbox"> Delete matters</label>
                <label><input type="checkbox"> Assign matters</label>
              </div>

              <h3>Financial Operations</h3>
              <div style="display: grid; gap: 4px; margin-bottom: 16px;">
                <label><input type="checkbox" checked> View billing</label>
                <label><input type="checkbox"> Generate invoices</label>
                <label><input type="checkbox"> Process payments</label>
                <label><input type="checkbox"> Financial reports</label>
              </div>

              <h3>System Administration</h3>
              <div style="display: grid; gap: 4px;">
                <label><input type="checkbox"> User management</label>
                <label><input type="checkbox"> System settings</label>
                <label><input type="checkbox"> Audit logs</label>
                <label><input type="checkbox"> Security settings</label>
              </div>
            </div>

            <div class="flex gap-2" style="margin-top: 16px;">
              <button class="btn primary">Save Permissions</button>
              <button class="btn">Reset to Default</button>
            </div>
          </div>
        </div>

        <!-- User Directory & Management -->
        <div class="panel">
          <h2>👥 User Directory & Administration</h2>
          <div class="flex flex-between flex-center mb-3">
            <div class="flex gap-2">
              <input type="text" placeholder="Search users..." style="width: 300px;">
              <select>
                <option>All Roles</option>
                <option>Super Administrator</option>
                <option>Department Manager</option>
                <option>Senior Conveyancer</option>
                <option>Conveyancing Officer</option>
                <option>Read-Only User</option>
              </select>
            </div>
            <button class="btn primary">+ Add User</button>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>User Details</th>
                <th>Department</th>
                <th>Role</th>
                <th>Permissions</th>
                <th>Last Login</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <div class="flex flex-center gap-3">
                    <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                      SJ
                    </div>
                    <div>
                      <div><strong>Sarah Johnson</strong></div>
                      <div class="text-muted text-sm">sarah.johnson@eastherts.gov.uk</div>
                    </div>
                  </div>
                </td>
                <td>Planning</td>
                <td><span class="status active">Department Manager</span></td>
                <td>
                  <div class="text-sm">47 permissions</div>
                  <div class="text-muted text-sm">Full department access</div>
                </td>
                <td>2 hours ago</td>
                <td><span class="status active">Active</span></td>
                <td>
                  <button class="btn sm">Edit</button>
                  <button class="btn sm">Permissions</button>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="flex flex-center gap-3">
                    <div style="width: 40px; height: 40px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                      MC
                    </div>
                    <div>
                      <div><strong>Mike Chen</strong></div>
                      <div class="text-muted text-sm">mike.chen@eastherts.gov.uk</div>
                    </div>
                  </div>
                </td>
                <td>Legal</td>
                <td><span class="status success">Senior Conveyancer</span></td>
                <td>
                  <div class="text-sm">34 permissions</div>
                  <div class="text-muted text-sm">Advanced processing</div>
                </td>
                <td>1 hour ago</td>
                <td><span class="status active">Active</span></td>
                <td>
                  <button class="btn sm">Edit</button>
                  <button class="btn sm">Permissions</button>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="flex flex-center gap-3">
                    <div style="width: 40px; height: 40px; background: var(--warning); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                      EW
                    </div>
                    <div>
                      <div><strong>Emma Wilson</strong></div>
                      <div class="text-muted text-sm">emma.wilson@eastherts.gov.uk</div>
                    </div>
                  </div>
                </td>
                <td>Housing</td>
                <td><span class="status warning">Conveyancing Officer</span></td>
                <td>
                  <div class="text-sm">23 permissions</div>
                  <div class="text-muted text-sm">Standard access</div>
                </td>
                <td>4 hours ago</td>
                <td><span class="status active">Active</span></td>
                <td>
                  <button class="btn sm">Edit</button>
                  <button class="btn sm">Permissions</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Audit Trail & Security -->
        <div class="panel">
          <h2>📋 Audit Trail & Security Monitoring</h2>
          <div class="grid grid-3">
            <div>
              <h3>Security Metrics</h3>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">0</div>
                <div class="label">Security Incidents</div>
              </div>
              <div class="stat-card" style="margin-bottom: 12px;">
                <div class="value text-success">342</div>
                <div class="label">Successful Logins Today</div>
              </div>
              <div class="stat-card">
                <div class="value text-warning">3</div>
                <div class="label">Failed Login Attempts</div>
              </div>
            </div>

            <div>
              <h3>Recent Activity</h3>
              <div style="max-height: 200px; overflow-y: auto;">
                <div style="border-bottom: 1px solid var(--line); padding: 8px 0;">
                  <div class="text-sm"><strong>Sarah Johnson</strong> updated matter DOM-2025-001</div>
                  <div class="text-muted text-xs">2 minutes ago</div>
                </div>
                <div style="border-bottom: 1px solid var(--line); padding: 8px 0;">
                  <div class="text-sm"><strong>Mike Chen</strong> generated financial report</div>
                  <div class="text-muted text-xs">15 minutes ago</div>
                </div>
                <div style="border-bottom: 1px solid var(--line); padding: 8px 0;">
                  <div class="text-sm"><strong>Emma Wilson</strong> logged in from new location</div>
                  <div class="text-muted text-xs">1 hour ago</div>
                </div>
              </div>
            </div>

            <div>
              <h3>System Settings</h3>
              <div class="form-group">
                <label>Organization</label>
                <input type="text" value="East Hertfordshire District Council">
              </div>
              <div class="form-group">
                <label>Session Timeout</label>
                <select>
                  <option>30 minutes</option>
                  <option>1 hour</option>
                  <option>4 hours</option>
                  <option>8 hours</option>
                </select>
              </div>
              <div class="form-group">
                <label>Password Policy</label>
                <div style="display: grid; gap: 4px;">
                  <label><input type="checkbox" checked> Minimum 8 characters</label>
                  <label><input type="checkbox" checked> Require special characters</label>
                  <label><input type="checkbox" checked> Force password changes</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Support Page -->
      <div id="support" class="page">
        <div class="page-header">
          <h1 class="page-title">Support</h1>
          <p class="page-subtitle">Help, documentation, and contact support</p>
        </div>

        <div class="panel">
          <h2>🎧 Get Help</h2>
          <div class="grid grid-3">
            <div class="stat-card">
              <div class="fw-600">📚 Documentation</div>
              <div class="text-sm text-muted mt-2">User guides and tutorials</div>
              <button class="btn mt-3">View Docs</button>
            </div>
            <div class="stat-card">
              <div class="fw-600">💬 Live Chat</div>
              <div class="text-sm text-muted mt-2">Chat with support team</div>
              <button class="btn mt-3">Start Chat</button>
            </div>
            <div class="stat-card">
              <div class="fw-600">📧 Email Support</div>
              <div class="text-sm text-muted mt-2">Send us an email</div>
              <button class="btn mt-3">Contact Us</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- AI Helpbot Assistant -->
  <div class="helpbot-container" id="helpbot-container">
    <button class="helpbot-toggle" id="helpbot-toggle" onclick="toggleHelpbot()">
      🤖 <span>AI Assistant</span>
    </button>
    <div class="helpbot-panel" id="helpbot-panel">
      <div class="helpbot-header">
        <h3>🤖 AI Assistant</h3>
        <button onclick="toggleHelpbot()" class="close-btn">×</button>
      </div>
      <div class="helpbot-messages" id="helpbot-messages">
        <div class="helpbot-message bot-message">
          <div class="message-avatar">🤖</div>
          <div class="message-content">
            <p>Hi! I'm your AI assistant. I can help you navigate the platform, upload documents, manage matters, and answer any questions you have!</p>
            <div class="message-actions">
              <button onclick="askHelpbot('How do I upload documents?')" class="action-btn">Upload Help</button>
              <button onclick="askHelpbot('Show me AI features')" class="action-btn">AI Features</button>
            </div>
          </div>
        </div>
      </div>
      <div class="helpbot-input">
        <input type="text" id="helpbot-input" placeholder="Ask me anything..." />
        <button onclick="sendHelpbotMessage()" class="send-btn">Send</button>
      </div>
    </div>
  </div>

  <!-- Property Map Modal -->
  <div class="map-modal" id="map-modal">
    <div class="map-modal-content">
      <div class="map-modal-header">
        <h3>Property Location & Insights</h3>
        <button onclick="closeMapModal()" class="close-btn">×</button>
      </div>
      <div class="map-container" id="map-container">
        <div class="map-placeholder">
          <div class="property-pin">📍</div>
          <div class="property-info">
            <h4 id="map-property-address">15 High Street, Bishop's Stortford</h4>
            <p id="map-property-details">Conservation Area • Freehold • £485,000</p>
          </div>
        </div>
        <div class="map-insights">
          <div class="insight-card">
            <h4>Local Market</h4>
            <p>Avg. Price: <strong>£465,000</strong></p>
            <p>Price Trend: <span class="positive">+3.2%</span> (12 months)</p>
          </div>
          <div class="insight-card">
            <h4>🚂 Transport</h4>
            <p>Station: 0.5 miles</p>
            <p>London: 35 mins direct</p>
          </div>
          <div class="insight-card">
            <h4>🏫 Schools</h4>
            <p>Rating: Good-Outstanding</p>
            <p>Primary: 0.2 miles</p>
          </div>
          <div class="insight-card">
            <h4>🛡️ Safety</h4>
            <p>Crime Rate: Below Average</p>
            <p>Flood Risk: Zone 1 (Low)</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== REAL-TIME NOTIFICATIONS SYSTEM ====================
    let ws = null;
    let notifications = [];
    let unreadCount = 0;
    
    // Initialize WebSocket connection for real-time notifications
    function initializeNotifications() {
      try {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(`${wsProtocol}//${window.location.host}/api/ws/notifications`);
        
        ws.onopen = () => {
          console.log('🔔 Real-time notifications connected');
          showToast('Connected', 'Real-time notifications active', 'success');
        };
        
        ws.onmessage = (event) => {
          const notification = JSON.parse(event.data);
          handleNotification(notification);
        };
        
        ws.onerror = () => {
          console.log('❌ Notification connection failed');
        };
        
        ws.onclose = () => {
          console.log('🔌 Notification connection closed');
          // Attempt to reconnect after 5 seconds
          setTimeout(initializeNotifications, 5000);
        };
      } catch (error) {
        console.log('Notifications in demo mode');
        // Load notifications from API instead
        loadNotifications();
      }
    }
    
    // Handle incoming notifications
    function handleNotification(notification) {
      if (notification.type === 'connected') {
        loadNotifications(); // Load existing notifications
        return;
      }
      
      // Add to notifications array
      notifications.unshift(notification);
      if (!notification.read) {
        unreadCount++;
      }
      
      // Update UI
      updateNotificationBadge();
      updateNotificationsList();
      
      // Show toast for new notifications
      if (notification.type !== 'connected') {
        showToast(
          notification.data.title || 'New Notification',
          notification.data.message,
          notification.data.priority === 'high' ? 'warning' : 'success'
        );
      }
    }
    
    // Load notifications from API
    async function loadNotifications() {
      try {
        const response = await fetch('/api/notifications/recent', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        
        if (response.ok) {
          const data = await response.json();
          notifications = data.notifications || [];
          unreadCount = notifications.filter(n => !n.read).length;
          updateNotificationBadge();
          updateNotificationsList();
        }
      } catch (error) {
        console.log('Loading demo notifications');
        // Demo notifications
        notifications = [
          {
            id: 'demo1',
            icon: '',
            title: 'Matter Progress Update',
            message: 'Matter 2001 has been updated to "Exchange Complete" status',
            timestamp: Date.now() - 300000,
            read: false,
            priority: 'high'
          },
          {
            id: 'demo2',
            icon: '',
            title: 'Document Processed',
            message: 'Contract.pdf has been successfully processed and indexed',
            timestamp: Date.now() - 900000,
            read: false,
            priority: 'normal'
          },
          {
            id: 'demo3',
            icon: '⏰',
            title: 'Task Deadline',
            message: 'Review Planning Documents is due in 2 hours',
            timestamp: Date.now() - 1800000,
            read: true,
            priority: 'high'
          }
        ];
        unreadCount = notifications.filter(n => !n.read).length;
        updateNotificationBadge();
        updateNotificationsList();
      }
    }
    
    // Update notification badge
    function updateNotificationBadge() {
      const badge = document.getElementById('notification-count');
      if (badge) {
        badge.textContent = unreadCount;
        badge.style.display = unreadCount > 0 ? 'inline' : 'none';
      }
    }
    
    // Update notifications list
    function updateNotificationsList() {
      const list = document.getElementById('notifications-list');
      if (!list) return;
      
      if (notifications.length === 0) {
        list.innerHTML = '<div class="notification-loading">No notifications</div>';
        return;
      }
      
      list.innerHTML = notifications.map(notification => `
        <div class="notification-item ${!notification.read ? 'unread' : ''}" onclick="markNotificationRead('${notification.id}')">
          <div style="display: flex; align-items: start; gap: 8px;">
            <span class="notification-icon">${notification.icon}</span>
            <div class="notification-content">
              <div class="notification-title">${notification.title}</div>
              <div class="notification-message">${notification.message}</div>
              <div class="notification-time">${formatTimeAgo(notification.timestamp)}</div>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // Toggle notifications dropdown
    function toggleNotifications() {
      const dropdown = document.getElementById('notifications-dropdown');
      if (dropdown) {
        dropdown.classList.toggle('show');
      }
    }
    
    // Mark notification as read
    async function markNotificationRead(notificationId) {
      const notification = notifications.find(n => n.id === notificationId);
      if (notification && !notification.read) {
        notification.read = true;
        unreadCount = Math.max(0, unreadCount - 1);
        updateNotificationBadge();
        updateNotificationsList();
        
        // API call to mark as read
        try {
          await fetch(`/api/notifications/${notificationId}/mark-read`, {
            method: 'POST',
            headers: {'Authorization': 'Bearer demo-token'}
          });
        } catch (error) {
          console.log('Demo mode: notification marked as read locally');
        }
      }
    }
    
    // Mark all notifications as read
    function markAllNotificationsRead() {
      notifications.forEach(n => n.read = true);
      unreadCount = 0;
      updateNotificationBadge();
      updateNotificationsList();
      
      showToast('Success', 'All notifications marked as read', 'success');
    }
    
    // Show toast notification
    function showToast(title, message, type = 'success') {
      // Create toast container if it doesn't exist
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container';
        document.body.appendChild(container);
      }
      
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <div class="toast-header">
          <div class="toast-title">${title}</div>
          <button class="toast-close" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
        <div class="toast-message">${message}</div>
      `;
      
      // Add to container
      container.appendChild(toast);
      
      // Animate in
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }
      }, 5000);
    }
    
    // Format time ago
    function formatTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (days > 0) return `${days}d ago`;
      if (hours > 0) return `${hours}h ago`;
      if (minutes > 0) return `${minutes}m ago`;
      return 'Just now';
    }
    
    // Close notifications dropdown when clicking outside
    document.addEventListener('click', (event) => {
      const dropdown = document.getElementById('notifications-dropdown');
      const button = document.getElementById('notification-btn');
      
      if (dropdown && dropdown.classList.contains('show')) {
        if (!dropdown.contains(event.target) && !button.contains(event.target)) {
          dropdown.classList.remove('show');
        }
      }
    });

    // ==================== AI HELPBOT SYSTEM ====================
    
    let helpbotOpen = false;
    
    function toggleHelpbot() {
      const panel = document.getElementById('helpbot-panel');
      const toggle = document.getElementById('helpbot-toggle');
      
      helpbotOpen = !helpbotOpen;
      
      if (helpbotOpen) {
        panel.classList.add('show');
        toggle.querySelector('span').textContent = 'Close';
      } else {
        panel.classList.remove('show');
        toggle.querySelector('span').textContent = 'AI Assistant';
      }
    }
    
    async function askHelpbot(question) {
      const messagesContainer = document.getElementById('helpbot-messages');
      const input = document.getElementById('helpbot-input');
      
      // Add user message
      addHelpbotMessage(question, 'user');
      
      // Clear input
      input.value = '';
      
      try {
        // Send to AI
        const formData = new FormData();
        formData.append('message', question);
        formData.append('context', getCurrentPageContext());
        
        const response = await fetch('/api/ai/helpbot/chat', {
          method: 'POST',
          headers: {'Authorization': 'Bearer demo-token'},
          body: formData
        });
        
        const data = await response.json();
        
        // Add bot response
        addHelpbotMessage(data.response, 'bot', data.actions);
        
      } catch (error) {
        addHelpbotMessage('Sorry, I encountered an error. Please try again!', 'bot');
      }
    }
    
    function addHelpbotMessage(message, sender, actions = []) {
      const messagesContainer = document.getElementById('helpbot-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `helpbot-message ${sender}-message`;
      
      const avatar = sender === 'bot' ? '🤖' : '👤';
      
      let actionsHtml = '';
      if (actions && actions.length > 0) {
        actionsHtml = '<div class="message-actions">' + 
          actions.map(action => `<button onclick="handleHelpbotAction('${action.action}', '${action.target}')" class="action-btn">${action.label}</button>`).join('') +
          '</div>';
      }
      
      messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
          <p>${message}</p>
          ${actionsHtml}
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function handleHelpbotAction(action, target) {
      switch (action) {
        case 'navigate':
          showPage(target.split('?')[0]);
          if (target.includes('action=create')) {
            // Handle create actions
            showToast('Navigation', `Opening ${target.split('?')[0]} page`, 'success');
          }
          break;
        case 'focus':
          const element = document.getElementById(target);
          if (element) element.focus();
          break;
        case 'explain':
          askHelpbot(`Tell me more about ${target.replace('_', ' ')}`);
          break;
        case 'tour':
          showToast('Tour', 'Platform tour feature coming soon!', 'success');
          break;
      }
    }
    
    function sendHelpbotMessage() {
      const input = document.getElementById('helpbot-input');
      const message = input.value.trim();
      
      if (message) {
        askHelpbot(message);
      }
    }
    
    function getCurrentPageContext() {
      const activePage = document.querySelector('.page.active');
      return activePage ? activePage.id : 'dashboard';
    }
    
    // ==================== ENHANCED SEARCH SYSTEM ====================
    
    let searchTimeout = null;
    let currentSearchResults = [];
    
    function initializeSearch() {
      const searchInput = document.getElementById('global-search');
      const suggestionsContainer = document.createElement('div');
      suggestionsContainer.className = 'search-suggestions';
      suggestionsContainer.id = 'search-suggestions';
      
      // Add suggestions container
      searchInput.parentElement.appendChild(suggestionsContainer);
      
      // Add search event listeners
      searchInput.addEventListener('input', handleSearchInput);
      searchInput.addEventListener('focus', showSearchSuggestions);
      searchInput.addEventListener('keydown', handleSearchKeydown);
      
      // Close suggestions when clicking outside
      document.addEventListener('click', (event) => {
        if (!searchInput.parentElement.contains(event.target)) {
          hideSearchSuggestions();
        }
      });
    }
    
    function handleSearchInput(event) {
      const query = event.target.value.trim();
      
      clearTimeout(searchTimeout);
      
      if (query.length >= 2) {
        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 300);
      } else {
        hideSearchSuggestions();
      }
    }
    
    async function performSearch(query) {
      try {
        const response = await fetch(`/api/search/global?q=${encodeURIComponent(query)}`, {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        
        const data = await response.json();
        currentSearchResults = data.results;
        
        displaySearchSuggestions(data.results.slice(0, 5));
        
      } catch (error) {
        console.error('Search error:', error);
        hideSearchSuggestions();
      }
    }
    
    function displaySearchSuggestions(results) {
      const container = document.getElementById('search-suggestions');
      
      if (results.length === 0) {
        hideSearchSuggestions();
        return;
      }
      
      container.innerHTML = results.map(result => `
        <div class="suggestion-item" onclick="selectSearchResult('${result.id}', '${result.type}')">
          <div class="suggestion-title">${result.icon} ${result.title}</div>
          <div class="suggestion-subtitle">${result.subtitle}</div>
        </div>
      `).join('');
      
      showSearchSuggestions();
    }
    
    function selectSearchResult(id, type) {
      // Navigate to the selected result
      switch (type) {
        case 'matter':
          showPage('matters');
          showToast('Navigation', `Opening matter ${id}`, 'success');
          break;
        case 'document':
          showPage('documents');
          showToast('Navigation', `Opening document ${id}`, 'success');
          break;
        case 'communication':
          showPage('communications');
          showToast('Navigation', `Opening message ${id}`, 'success');
          break;
        case 'task':
          showPage('calendar');
          showToast('Navigation', `Opening task ${id}`, 'success');
          break;
      }
      
      hideSearchSuggestions();
      document.getElementById('global-search').value = '';
    }
    
    function showSearchSuggestions() {
      const container = document.getElementById('search-suggestions');
      if (container && container.children.length > 0) {
        container.classList.add('show');
      }
    }
    
    function hideSearchSuggestions() {
      const container = document.getElementById('search-suggestions');
      if (container) {
        container.classList.remove('show');
      }
    }
    
    function handleSearchKeydown(event) {
      if (event.key === 'Enter') {
        const query = event.target.value.trim();
        if (query) {
          openFullSearchResults(query);
        }
      }
    }
    
    function openFullSearchResults(query) {
      showToast('Search', `Searching for "${query}"...`, 'success');
      // In a real implementation, this would open a full search results page
      hideSearchSuggestions();
    }
    
    // ==================== AI PROPERTY MAPPING SYSTEM ====================
    
    function showPropertyMap(address, coordinates) {
      const modal = document.getElementById('map-modal');
      const addressElement = document.getElementById('map-property-address');
      const detailsElement = document.getElementById('map-property-details');
      
      // Update property information
      addressElement.textContent = address || '15 High Street, Bishop\'s Stortford';
      detailsElement.textContent = 'Conservation Area • Freehold • £485,000';
      
      // Show modal
      modal.classList.add('show');
      
      // In a real implementation, this would initialize a proper map
      console.log('Showing map for:', address, coordinates);
    }
    
    function closeMapModal() {
      const modal = document.getElementById('map-modal');
      modal.classList.remove('show');
    }
    
    // ==================== AI DOCUMENT ANALYSIS FUNCTIONS ====================
    
    async function analyzeDocumentWithAI(file, matterId) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('matter_id', matterId || 'DEMO001');
      
      try {
        const response = await fetch('/api/ai/document/analyze', {
          method: 'POST',
          headers: {'Authorization': 'Bearer demo-token'},
          body: formData
        });
        
        const analysis = await response.json();
        
        // Show AI analysis results
        displayDocumentAnalysis(analysis);
        
        // If coordinates are available, offer to show map
        if (analysis.coordinates) {
          setTimeout(() => {
            showToast('AI Analysis', `📍 Property location identified! Click here to view map`, 'success');
          }, 2000);
        }
        
        return analysis;
        
      } catch (error) {
        console.error('AI analysis error:', error);
        showToast('Error', 'AI analysis failed. Please try again.', 'error');
        return null;
      }
    }
    
    function displayDocumentAnalysis(analysis) {
      // Display comprehensive AI analysis results
      const resultsHtml = `
        <div class="ai-analysis-results">
          <h3>🤖 AI Document Analysis Complete</h3>
          
          <div class="analysis-section">
            <h4>📍 Property Information</h4>
            <p><strong>Address:</strong> ${analysis.extracted_data.property_address}</p>
            <p><strong>Type:</strong> ${analysis.extracted_data.property_type}</p>
            <p><strong>Council:</strong> ${analysis.extracted_data.council}</p>
          </div>
          
          <div class="analysis-section">
            <h4>⚠️ Risk Assessment</h4>
            <p><strong>Overall Risk:</strong> <span class="risk-${analysis.risk_assessment.overall_risk.toLowerCase()}">${analysis.risk_assessment.overall_risk}</span></p>
            <p><strong>Risk Score:</strong> ${(analysis.risk_assessment.risk_score * 100).toFixed(1)}%</p>
          </div>
          
          <div class="analysis-section">
            <h4>📝 AI Summary</h4>
            <p>${analysis.ai_summary}</p>
          </div>
          
          <div class="analysis-section">
            <h4>⏱️ Timeline Prediction</h4>
            <p><strong>Exchange:</strong> ${analysis.timeline_prediction.estimated_exchange}</p>
            <p><strong>Completion:</strong> ${analysis.timeline_prediction.estimated_completion}</p>
            <p><strong>Confidence:</strong> ${(analysis.timeline_prediction.confidence * 100).toFixed(0)}%</p>
          </div>
          
          <button onclick="showPropertyMap('${analysis.extracted_data.property_address}', ${JSON.stringify(analysis.coordinates)})" class="btn">📍 View Property Map</button>
        </div>
      `;
      
      // Show in a modal or dedicated area
      showToast('AI Analysis', 'Document analysis complete! Check the documents page for full results.', 'success');
      
      // Store analysis for later display
      window.lastAnalysis = analysis;
    }
    
    // ==================== PAGE NAVIGATION ====================
    
    // Page Navigation
    function showPage(pageId) {
      // Hide all pages
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      // Show selected page
      document.getElementById(pageId).classList.add('active');
      
      // Update navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Load page data
      loadPageData(pageId);
    }
    
    // Load data for specific pages
    function loadPageData(pageId) {
      switch(pageId) {
        case 'dashboard':
          loadDashboardData();
          break;
        case 'matters':
          loadMattersData();
          break;
        case 'documents':
          loadDocumentsData();
          break;
        case 'calendar':
          loadCalendarData();
          break;
        case 'communications':
          loadCommunicationsData();
          break;
        case 'users':
          loadUsersData();
          break;
        case 'billing':
          loadBillingData();
          break;
        case 'reports':
          loadReportsData();
          break;
        case 'workflow':
          loadWorkflowData();
          break;
        case 'settings':
          loadSettingsData();
          break;
        case 'integrations':
          loadIntegrationsData();
          break;
      }
    }
    
    // API calls to load real data
    async function loadDashboardData() {
      try {
        const response = await fetch('/api/dashboard/overview', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const data = await response.json();
        
        // Update dashboard metrics with real data
        updateDashboardMetrics(data.key_metrics);
        updateRecentMatters(data.recent_matters);
        console.log('Dashboard data loaded:', data);
      } catch (error) {
        console.error('Dashboard data loading failed:', error);
      }
    }
    
    function updateDashboardMetrics(metrics) {
      // Update active matters
      const activeMattersCard = document.querySelector('.stat-card');
      if (activeMattersCard) {
        const value = activeMattersCard.querySelector('.value');
        const trend = activeMattersCard.querySelector('.trend');
        if (value) value.textContent = metrics.active_matters.value;
        if (trend) trend.textContent = `↗ ${metrics.active_matters.change} ${metrics.active_matters.period}`;
      }
    }
    
    function updateRecentMatters(matters) {
      const tbody = document.querySelector('#dashboard .table tbody');
      if (tbody && matters) {
        tbody.innerHTML = matters.map(matter => `
          <tr>
            <td><strong>${matter.id}</strong></td>
            <td>${matter.property_address}</td>
            <td>${matter.council}</td>
            <td><span class="status ${matter.status.replace('_', ' ')}">${matter.status.replace('_', ' ').toUpperCase()}</span></td>
            <td>${matter.assigned_to}</td>
            <td>${new Date(matter.due_date).toLocaleDateString()}</td>
            <td><button class="btn sm" onclick="viewMatter('${matter.id}')">View</button></td>
          </tr>
        `).join('');
      }
    }
    
    async function loadMattersData() {
      try {
        const response = await fetch('/api/matters', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const data = await response.json();
        
        // Update matters table with real data
        updateMattersTable(data.matters);
        console.log('Matters data loaded:', data);
      } catch (error) {
        console.error('Matters data loading failed:', error);
      }
    }
    
    function updateMattersTable(matters) {
      const tbody = document.querySelector('#matters .table tbody');
      if (tbody && matters) {
        tbody.innerHTML = matters.map(matter => `
          <tr>
            <td><strong>${matter.ref}</strong></td>
            <td>
              <div>${matter.property_address.split(',')[0]}</div>
              <div class="text-muted text-sm">${matter.property_address}</div>
            </td>
            <td>${matter.council}</td>
            <td>${matter.department}</td>
            <td><span class="status ${matter.status}">${matter.status.replace('_', ' ').toUpperCase()}</span></td>
            <td>${matter.assigned_to ? matter.assigned_to.name : 'Unassigned'}</td>
            <td><span class="text-${matter.priority === 'high' ? 'warning' : 'muted'}">${matter.priority.toUpperCase()}</span></td>
            <td>${new Date(matter.due_date).toLocaleDateString()}</td>
            <td>£${matter.estimated_cost ? matter.estimated_cost.toFixed(2) : '0.00'}</td>
            <td>
              <button class="btn sm" onclick="viewMatter('${matter.id}')">View</button>
              <button class="btn sm" onclick="editMatter('${matter.id}')">Edit</button>
            </td>
          </tr>
        `).join('');
      }
    }
    
    async function loadCalendarData() {
      try {
        // Load calendar events
        const eventsResponse = await fetch('/api/calendar/events', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const eventsData = await eventsResponse.json();
        
        // Load tasks
        const tasksResponse = await fetch('/api/tasks', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const tasksData = await tasksResponse.json();
        
        // Update calendar view with real data
        updateCalendarEvents(eventsData.events);
        updateTasksList(tasksData.tasks);
        updateTaskStats(tasksData.status_summary);
        
        console.log('✅ Calendar data loaded successfully:', { 
          events: eventsData.events?.length || 0, 
          tasks: tasksData.tasks?.length || 0,
          taskStatuses: tasksData.status_summary
        });
      } catch (error) {
        console.error('Calendar data loading failed:', error);
      }
    }
    
    function updateCalendarEvents(events) {
      const calendarContainer = document.querySelector('#calendar .calendar-events');
      if (calendarContainer && events) {
        // Update calendar display with real events
        console.log('Calendar events updated:', events);
      }
    }
    
    function updateTasksList(tasks) {
      const tasksContainer = document.querySelector('#calendar .today-tasks');
      if (tasksContainer && tasks) {
        const taskElements = tasks.slice(0, 5).map(task => `
          <div style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; margin-bottom: 12px;" data-task-id="${task.id}">
            <div class="flex flex-between flex-center mb-2">
              <strong>${task.title}</strong>
              <span class="status ${task.status}">${task.status === 'pending' ? 'Due Today' : task.status.replace('_', ' ')}</span>
            </div>
            <div class="text-muted text-sm">Matter: ${task.matter_id || 'General Task'} • Assigned: ${task.assigned_to?.name || 'Unassigned'}</div>
            <div class="flex gap-2" style="margin-top: 12px;">
              <button class="btn sm success" onclick="completeTask('${task.id}')">✓ Complete</button>
              <button class="btn sm" onclick="viewTaskDetails('${task.id}')">View Details</button>
            </div>
          </div>
        `).join('');
        
        tasksContainer.innerHTML = taskElements;
        console.log('Tasks updated:', tasks.length, 'tasks loaded');
      }
    }
    
    function updateTaskStats(statusSummary) {
      // Update task statistics in the calendar view
      const statsCards = document.querySelectorAll('#calendar .stat-card .value');
      if (statsCards.length >= 4 && statusSummary) {
        statsCards[0].textContent = statusSummary.pending + statusSummary.in_progress;
        statsCards[1].textContent = statusSummary.in_progress;
        statsCards[2].textContent = statusSummary.completed;
        // Keep average task duration as is for now
      }
    }

    async function loadCommunicationsData() {
      try {
        // Load messages and notifications
        const messagesResponse = await fetch('/api/communications/messages', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const messagesData = await messagesResponse.json();
        
        // Load communication analytics
        const analyticsResponse = await fetch('/api/communications/analytics', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const analyticsData = await analyticsResponse.json();
        
        // Update communications interface
        updateMessagesList(messagesData);
        updateCommunicationsAnalytics(analyticsData);
        
        console.log('Communications system loaded:', { messages: messagesData, analytics: analyticsData });
      } catch (error) {
        console.error('Communications data loading failed:', error);
      }
    }
    
    function updateMessagesList(messages) {
      // Update communications interface with real message data
      const tbody = document.querySelector('#communications .table tbody');
      if (tbody && messages.length) {
        tbody.innerHTML = messages.map(msg => `
          <tr>
            <td><strong>${msg.from || 'System'}</strong></td>
            <td>${msg.subject}</td>
            <td>Matter ${msg.matter_id || 'N/A'}</td>
            <td>${new Date(msg.timestamp).toLocaleDateString()}</td>
            <td><span class="status ${msg.priority}">${msg.priority.toUpperCase()}</span></td>
            <td>
              <button class="btn sm" onclick="viewMessage('${msg.id}')">View</button>
              <button class="btn sm" onclick="replyMessage('${msg.id}')">Reply</button>
            </td>
          </tr>
        `).join('');
      }
      console.log('Secure communications system active with', messages.length, 'messages');
    }
    
    function updateCommunicationsAnalytics(analytics) {
      const statsCards = document.querySelectorAll('#communications .stat-card .value');
      if (statsCards.length >= 4 && analytics) {
        statsCards[0].textContent = analytics.total_messages || '0';
        statsCards[1].textContent = analytics.unread_count || '0';
        statsCards[2].textContent = analytics.active_clients || '0';
        statsCards[3].textContent = `${analytics.response_rate || 0}%`;
      }
    }

    // Message interaction functions
    async function viewMessage(messageId) {
      try {
        const response = await fetch(`/api/communications/messages/${messageId}`, {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        if (response.ok) {
          const message = await response.json();
          console.log('Viewing message:', message);
          // Open message viewer modal
        }
      } catch (error) {
        console.error('Error viewing message:', error);
      }
    }

    async function replyMessage(messageId) {
      try {
        console.log('Opening reply interface for message:', messageId);
        // Open reply composition interface
      } catch (error) {
        console.error('Error replying to message:', error);
      }
    }

    async function loadDocumentsData() {
      try {
        // Load document processing queue
        const queueResponse = await fetch('/api/documents/processing-queue', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const queueData = await queueResponse.json();
        
        // Load all documents
        const documentsResponse = await fetch('/api/documents', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const documentsData = await documentsResponse.json();
        
        // Load document analytics
        const analyticsResponse = await fetch('/api/documents/analytics', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const analyticsData = await analyticsResponse.json();
        
        // Update document processing queue
        updateDocumentQueue(queueData.queue);
        updateDocumentStats(queueData);
        
        // Update documents listing
        updateDocumentsList(documentsData);
        updateDocumentsAnalytics(analyticsData);
        
        console.log('Documents data loaded:', { queue: queueData, documents: documentsData, analytics: analyticsData });
      } catch (error) {
        console.error('Document processing data loading failed:', error);
      }
    }
    
    function updateDocumentQueue(queue) {
      // Update document processing queue display
      console.log('Document queue updated:', queue);
    }
    
    function updateDocumentStats(stats) {
      // Update document processing statistics
      const statsCards = document.querySelectorAll('#documents .stat-card .value');
      if (statsCards.length >= 3 && stats) {
        statsCards[1].textContent = stats.processing_count;
        statsCards[3].textContent = Math.round((stats.completed_count / stats.total_count) * 100) + '%';
      }
    }
    
    function updateDocumentsList(documents) {
      const tbody = document.querySelector('#documents .table tbody');
      if (tbody && documents.length) {
        tbody.innerHTML = documents.map(doc => `
          <tr>
            <td><i class="icon fas fa-file-pdf"></i> ${doc.filename}</td>
            <td>${doc.type}</td>
            <td>Matter ${doc.matter_id}</td>
            <td>${new Date(doc.created_at).toLocaleDateString()}</td>
            <td>${(doc.size / 1024).toFixed(1)} KB</td>
            <td><span class="status ${doc.status}">${doc.status.toUpperCase()}</span></td>
            <td>
              <button class="btn sm" onclick="viewDocument('${doc.id}')">View</button>
              <button class="btn sm" onclick="downloadDocument('${doc.id}')">Download</button>
            </td>
          </tr>
        `).join('');
      }
    }
    
    function updateDocumentsAnalytics(analytics) {
      const statsCards = document.querySelectorAll('#documents .stat-card .value');
      if (statsCards.length >= 4 && analytics) {
        statsCards[0].textContent = analytics.total_documents || '0';
        if (statsCards.length >= 4) {
          statsCards[2].textContent = `${(analytics.storage_used_gb || 0).toFixed(1)} GB`;
        }
      }
    }

    // Document interaction functions
    async function viewDocument(documentId) {
      try {
        const response = await fetch(`/api/documents/${documentId}/view`, {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        if (response.ok) {
          // Open document viewer
          console.log('Opening document viewer for:', documentId);
        }
      } catch (error) {
        console.error('Error viewing document:', error);
      }
    }

    async function downloadDocument(documentId) {
      try {
        const response = await fetch(`/api/documents/${documentId}/download`, {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `document_${documentId}`;
          a.click();
          window.URL.revokeObjectURL(url);
        }
      } catch (error) {
        console.error('Error downloading document:', error);
      }
    }
    
    async function loadUsersData() {
      try {
        const response = await fetch('/api/users', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const data = await response.json();
        
        // Update users table with real data
        updateUsersTable(data.users);
        console.log('Users data loaded:', data);
      } catch (error) {
        console.error('Users data loading failed:', error);
      }
    }
    
    function updateUsersTable(users) {
      const tbody = document.querySelector('#users .table tbody');
      if (tbody && users) {
        tbody.innerHTML = users.map(user => `
          <tr>
            <td><strong>${user.full_name}</strong></td>
            <td>${user.email}</td>
            <td>${user.department}</td>
            <td>${user.role.replace('_', ' ')}</td>
            <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
            <td><span class="status ${user.is_active ? 'active' : 'inactive'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
            <td>
              <button class="btn sm" onclick="editUser(${user.id})">Edit</button>
              <button class="btn sm" onclick="managePermissions(${user.id})">Permissions</button>
            </td>
          </tr>
        `).join('');
      }
    }
    
    async function loadBillingData() {
      try {
        const summaryResponse = await fetch('/api/billing/summary', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const summaryData = await summaryResponse.json();
        
        const invoicesResponse = await fetch('/api/billing/invoices', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const invoicesData = await invoicesResponse.json();
        
        // Update financial dashboard with real data
        updateFinancialMetrics(summaryData);
        updateInvoicesTable(summaryData.recent_invoices);
        
        console.log('Billing data loaded:', { summary: summaryData, invoices: invoicesData });
      } catch (error) {
        console.error('Billing data loading failed:', error);
      }
    }
    
    function updateFinancialMetrics(data) {
      // Update financial metrics cards
      const statsCards = document.querySelectorAll('#billing .stat-card .value');
      if (statsCards.length >= 4 && data.current_month) {
        statsCards[0].textContent = `£${data.current_month.revenue.toLocaleString()}`;
        statsCards[1].textContent = `£${data.year_to_date.revenue.toLocaleString()}`;
        statsCards[2].textContent = `£${data.outstanding.amount.toLocaleString()}`;
        statsCards[3].textContent = `£${data.averages.per_matter}`;
      }
    }
    
    function updateInvoicesTable(invoices) {
      const tbody = document.querySelector('#billing .table tbody');
      if (tbody && invoices) {
        tbody.innerHTML = invoices.map(invoice => `
          <tr>
            <td><strong>${invoice.id}</strong></td>
            <td>${invoice.department}</td>
            <td>${invoice.period}</td>
            <td>-</td>
            <td>£${invoice.amount.toFixed(2)}</td>
            <td><span class="status ${invoice.status}">${invoice.status.toUpperCase()}</span></td>
            <td>${new Date(invoice.due_date).toLocaleDateString()}</td>
            <td>
              <button class="btn sm">View</button>
              <button class="btn sm">Download PDF</button>
            </td>
          </tr>
        `).join('');
      }
    }

    async function loadReportsData() {
      try {
        // Reports would integrate with analytics APIs
        console.log('Reports system ready - comprehensive analytics available');
      } catch (error) {
        console.error('Reports data loading failed:', error);
      }
    }

    async function loadWorkflowData() {
      try {
        // Workflow management system ready
        console.log('Workflow management system ready - advanced workflow engine active');
      } catch (error) {
        console.error('Workflow data loading failed:', error);
      }
    }

    async function loadSettingsData() {
      try {
        const response = await fetch('/api/settings', {
          headers: {'Authorization': 'Bearer demo-token'}
        });
        const data = await response.json();
        
        // Update settings with real configuration
        console.log('Settings loaded:', data);
      } catch (error) {
        console.error('Settings loading failed:', error);
      }
    }
    
    async function loadIntegrationsData() {
      try {
        const response = await fetch('/api/enterprise/integrations');
        const data = await response.json();
        console.log('Integrations data:', data);
      } catch (error) {
        console.log('Integrations data loading (demo mode)');
      }
    }
    
    // Action functions
    function showCreateMatterModal() {
      alert('Create Matter modal would open here - this would be a proper form in production');
    }
    
    function viewMatter(matterId) {
      alert(`View matter ${matterId} - this would open a detailed view`);
    }
    
    function editMatter(matterId) {
      alert(`Edit matter ${matterId} - this would open an edit form`);
    }
    
    function editUser(userId) {
      alert(`Edit user ${userId} - this would open a user edit form`);
    }
    
    function managePermissions(userId) {
      alert(`Manage permissions for user ${userId} - this would open permissions dialog`);
    }
    
    // Enhanced file upload with AI analysis
    async function handleFileUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      
      const file = files[0];
      
      // Show upload progress
      showToast('Upload', `Uploading ${file.name}...`, 'success');
      
      try {
        // Perform AI analysis
        const analysis = await analyzeDocumentWithAI(file, getCurrentMatterId());
        
        if (analysis) {
          // Show success with AI insights
          showToast('AI Analysis', `✅ ${file.name} uploaded and analyzed successfully!`, 'success');
          
          // Auto-show map if property identified
          if (analysis.coordinates) {
            setTimeout(() => {
              showPropertyMap(analysis.extracted_data.property_address, analysis.coordinates);
            }, 2000);
          }
        }
        
      } catch (error) {
        showToast('Error', `❌ Failed to upload ${file.name}`, 'error');
      }
    }
    
    function getCurrentMatterId() {
      // In a real app, this would get the current matter context
      return 'DOM-2025-001';
    }
    
    // Demo function to trigger AI analysis
    function demonstrateAIFeatures() {
      // Show document analysis demo
      const demoAnalysis = {
        extracted_data: {
          property_address: "15 High Street, Bishop's Stortford, CM23 2LS",
          property_type: "Residential Freehold",
          council: "East Hertfordshire Council",
          vendor_name: "Sarah Thompson",
          purchaser_name: "Michael & Emma Davis"
        },
        risk_assessment: {
          overall_risk: "MEDIUM",
          risk_score: 0.35,
          factors: ["Conservation area restrictions", "Potential boundary dispute"]
        },
        timeline_prediction: {
          estimated_exchange: "2025-02-15",
          estimated_completion: "2025-03-01",
          confidence: 0.85
        },
        ai_summary: "This is a straightforward residential purchase in a conservation area. The main consideration is ensuring compliance with conservation area planning restrictions. Local searches show no significant environmental concerns.",
        coordinates: {lat: 51.8712, lng: 0.1602}
      };
      
      displayDocumentAnalysis(demoAnalysis);
    }
    
    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the platform
      loadDashboardData();
      
      // Initialize real-time notifications
      initializeNotifications();
      
      // Initialize AI features
      initializeSearch();
      
      // Initialize helpbot
      document.getElementById('helpbot-toggle').addEventListener('click', toggleHelpbot);
      
      // Add helpbot input handler
      document.getElementById('helpbot-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendHelpbotMessage();
        }
      });
      
      console.log('🚀 Domus Enterprise Platform initialized with AI features and real-time notifications');
      
      // Show welcome notification
      setTimeout(() => {
        showToast('Welcome', 'Enterprise platform is ready with AI assistance and real-time notifications', 'success');
        
        // Initialize helpbot with welcome message
        addHelpbotMessage('Hello! I\'m your AI assistant. I can help you navigate the platform, answer questions about conveyancing, and assist with any issues you encounter. How can I help you today?', 'bot', [
          {action: 'navigate', target: 'matters', label: 'View Matters'},
          {action: 'navigate', target: 'documents', label: 'View Documents'},
          {action: 'tour', target: 'platform', label: 'Take Tour'}
        ]);
      }, 1000);
    });

    // ==================== AI FUNCTIONS ====================
    
    // AI Document Analysis
    async function processAIDocument(file, container) {
      const processingElement = container.querySelector('.ai-processing');
      const progressBar = processingElement.querySelector('.progress-fill');
      const steps = processingElement.querySelectorAll('.processing-step');
      
      // Reset states
      steps.forEach(step => step.classList.remove('active', 'completed'));
      
      try {
        // Step 1: OCR Processing
        steps[0].classList.add('active');
        progressBar.style.width = '20%';
        await new Promise(resolve => setTimeout(resolve, 2000));
        steps[0].classList.remove('active');
        steps[0].classList.add('completed');
        
        // Step 2: Content Analysis
        steps[1].classList.add('active');
        progressBar.style.width = '40%';
        await new Promise(resolve => setTimeout(resolve, 1500));
        steps[1].classList.remove('active');
        steps[1].classList.add('completed');
        
        // Step 3: Risk Assessment
        steps[2].classList.add('active');
        progressBar.style.width = '70%';
        await new Promise(resolve => setTimeout(resolve, 2000));
        steps[2].classList.remove('active');
        steps[2].classList.add('completed');
        
        // Step 4: Timeline Prediction
        steps[3].classList.add('active');
        progressBar.style.width = '90%';
        await new Promise(resolve => setTimeout(resolve, 1000));
        steps[3].classList.remove('active');
        steps[3].classList.add('completed');
        
        // Final completion
        progressBar.style.width = '100%';
        
        // Call backend API
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('/api/ai/document-analysis', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: formData
        });
        
        if (!response.ok) throw new Error('Analysis failed');
        
        const result = await response.json();
        
        // Hide processing, show results
        processingElement.style.display = 'none';
        showAIResults(result, container);
        
      } catch (error) {
        console.error('AI Analysis error:', error);
        showToast('AI analysis failed. Please try again.', 'error');
        processingElement.style.display = 'none';
      }
    }
    
    function showAIResults(data, container) {
      const resultsPanel = container.querySelector('.ai-results-panel');
      resultsPanel.style.display = 'block';
      
      // Update Summary Tab
      const summaryTab = document.getElementById('ai-summary');
      summaryTab.innerHTML = `
        <h4>Document Summary</h4>
        <p><strong>Type:</strong> ${data.document_type}</p>
        <p><strong>Property:</strong> ${data.property_address}</p>
        <div class="summary-text">
          <h5>Key Information</h5>
          <p>${data.summary}</p>
          <h5>Important Dates</h5>
          <ul>
            ${data.important_dates.map(date => `<li>${date}</li>`).join('')}
          </ul>
        </div>
      `;
      
      // Update Risks Tab
      const risksTab = document.getElementById('ai-risks');
      risksTab.innerHTML = `
        <h4>Risk Assessment</h4>
        ${data.risks.map(risk => `
          <div class="risk-card ${risk.level}">
            <div class="risk-header">
              <span class="risk-title">${risk.title}</span>
              <span class="risk-level ${risk.level}">${risk.level.toUpperCase()}</span>
            </div>
            <p class="risk-description">${risk.description}</p>
            <div class="confidence-bar">
              <div class="confidence-fill" style="width: ${risk.confidence}%"></div>
            </div>
            <small>Confidence: ${risk.confidence}%</small>
          </div>
        `).join('')}
      `;
      
      // Update Timeline Tab
      const timelineTab = document.getElementById('ai-timeline');
      timelineTab.innerHTML = `
        <h4>Predicted Timeline</h4>
        <p><strong>Estimated Completion:</strong> ${data.timeline.estimated_completion}</p>
        <p><strong>Critical Path:</strong> ${data.timeline.critical_path}</p>
        <div class="timeline-steps">
          ${data.timeline.milestones.map(milestone => `
            <div class="timeline-step">
              <strong>${milestone.title}</strong> - ${milestone.date}
              <p>${milestone.description}</p>
            </div>
          `).join('')}
        </div>
      `;
      
      // Update Mapping Tab
      const mappingTab = document.getElementById('ai-mapping');
      mappingTab.innerHTML = `
        <h4>Property Location</h4>
        <div class="property-map-container">
          <div class="property-map" id="property-leaflet-map">
          </div>
          <div class="map-info">
            <h4>Property Details</h4>
            <div class="info-item">
              <span class="info-label">Address:</span>
              <span class="info-value">${data.mapping.address}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Postcode:</span>
              <span class="info-value">${data.mapping.postcode}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Council:</span>
              <span class="info-value">${data.mapping.council}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Flood Risk:</span>
              <span class="info-value">${data.mapping.flood_risk}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Environmental:</span>
              <span class="info-value">${data.mapping.environmental_factors.join(', ')}</span>
            </div>
          </div>
        </div>
      `;
      
      // Initialize the map after a short delay to ensure DOM is ready
      setTimeout(() => initializePropertyMap(data.mapping), 100);
    }
    
    // AI Tab Switching
    function switchAITab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[onclick="switchAITab('${tabName}')"]`).classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.ai-tab-content').forEach(content => content.style.display = 'none');
      document.getElementById(`ai-${tabName}`).style.display = 'block';
    }
    
    // AI Search Enhancement
    let aiSearchTimeout;
    async function enhanceSearch(input) {
      clearTimeout(aiSearchTimeout);
      
      aiSearchTimeout = setTimeout(async () => {
        const query = input.value.trim();
        if (query.length < 2) {
          hideSearchSuggestions();
          return;
        }
        
        try {
          const response = await fetch('/api/ai/search', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ query, limit: 5 })
          });
          
          if (response.ok) {
            const results = await response.json();
            showSearchSuggestions(results.suggestions, input);
          }
        } catch (error) {
          console.error('AI search error:', error);
        }
      }, 300);
    }
    
    function showSearchSuggestions(suggestions, input) {
      let suggestionsElement = input.parentElement.querySelector('.search-suggestions');
      
      if (!suggestionsElement) {
        suggestionsElement = document.createElement('div');
        suggestionsElement.className = 'search-suggestions';
        input.parentElement.appendChild(suggestionsElement);
      }
      
      suggestionsElement.innerHTML = suggestions.map(suggestion => `
        <div class="suggestion-item" onclick="selectSuggestion('${suggestion.id}', '${suggestion.title}')">
          <div class="suggestion-title">${suggestion.title}</div>
          <div class="suggestion-description">${suggestion.description}</div>
        </div>
      `).join('');
      
      suggestionsElement.classList.add('show');
    }
    
    function hideSearchSuggestions() {
      document.querySelectorAll('.search-suggestions').forEach(el => {
        el.classList.remove('show');
      });
    }
    
    function selectSuggestion(id, title) {
      hideSearchSuggestions();
      // Implement navigation or action based on suggestion
      console.log('Selected suggestion:', id, title);
    }
    
    // Helpbot Functions
    async function sendHelpbotMessage() {
      const input = document.querySelector('.helpbot-input input');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Add user message
      addHelpbotMessage(message, 'user');
      input.value = '';
      
      try {
        const response = await fetch('/api/ai/helpbot', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ message, context: getCurrentPageContext() })
        });
        
        if (response.ok) {
          const result = await response.json();
          addHelpbotMessage(result.response, 'bot', result.suggestions);
        } else {
          throw new Error('Helpbot response failed');
        }
      } catch (error) {
        console.error('Helpbot error:', error);
        addHelpbotMessage('I apologize, but I\'m having trouble connecting right now. Please try again in a moment.', 'bot');
      }
    }
    
    function getCurrentPageContext() {
      const page = document.querySelector('.page.active')?.id || 'dashboard';
      const visibleData = {
        page: page,
        url: window.location.hash,
        timestamp: new Date().toISOString()
      };
      
      // Add page-specific context
      if (page === 'matters') {
        const matterElements = document.querySelectorAll('.matter-item');
        visibleData.matters_count = matterElements.length;
      } else if (page === 'documents') {
        const docElements = document.querySelectorAll('.document-item');
        visibleData.documents_count = docElements.length;
      }
      
      return visibleData;
    }
    
    function executeSuggestion(suggestion) {
      if (suggestion.action === 'navigate') {
        navigateTo(suggestion.target);
        toggleHelpbot();
      } else if (suggestion.action === 'tour') {
        startPlatformTour();
        toggleHelpbot();
      }
    }
    
    function startPlatformTour() {
      showToast('Platform tour started! Follow the highlighted areas.', 'info');
      // Implement tour logic here
    }
    
    // Task Management Functions
    async function completeTask(taskId) {
      try {
        const response = await fetch(`/api/tasks/${taskId}/complete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token') || 'demo-token'}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          showToast('Task completed successfully!', 'success');
          loadCalendarData(); // Reload tasks
        } else {
          throw new Error('Failed to complete task');
        }
      } catch (error) {
        console.error('Error completing task:', error);
        showToast('Failed to complete task', 'error');
      }
    }
    
    function viewTaskDetails(taskId) {
      showToast('Task Details', `Opening details for task ${taskId}`, 'info');
      // Implement task details view
    }
    
    // Map Functions
    let propertyMap = null;
    
    function initializePropertyMap(mappingData) {
      const mapElement = document.getElementById('property-leaflet-map');
      if (!mapElement) return;
      
      // Clear existing map
      if (propertyMap) {
        propertyMap.remove();
      }
      
      try {
        // Initialize the map
        propertyMap = L.map('property-leaflet-map').setView([mappingData.coordinates.lat, mappingData.coordinates.lng], 15);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(propertyMap);
        
        // Add property marker
        const propertyMarker = L.marker([mappingData.coordinates.lat, mappingData.coordinates.lng])
          .addTo(propertyMap)
          .bindPopup(`
            <div class="map-popup">
              <strong>${mappingData.address}</strong><br>
              <small>${mappingData.postcode}</small><br>
              <em>Council: ${mappingData.council}</em>
            </div>
          `);
        
        // Add flood risk overlay if high risk
        if (mappingData.flood_risk === 'High') {
          L.circle([mappingData.coordinates.lat, mappingData.coordinates.lng], {
            color: '#ef4444',
            fillColor: '#ef4444',
            fillOpacity: 0.2,
            radius: 200
          }).addTo(propertyMap).bindPopup('Flood Risk Area');
        }
        
        // Add environmental markers
        mappingData.environmental_factors.forEach((factor, index) => {
          if (factor !== 'None') {
            const offset = 0.001 * (index + 1);
            L.marker([
              mappingData.coordinates.lat + offset, 
              mappingData.coordinates.lng + offset
            ], {
              icon: L.divIcon({
                className: 'environmental-marker',
                html: '⚠️',
                iconSize: [20, 20]
              })
            }).addTo(propertyMap).bindPopup(`Environmental Factor: ${factor}`);
          }
        });
        
        // Open the property popup by default
        setTimeout(() => propertyMarker.openPopup(), 500);
        
      } catch (error) {
        console.error('Error initializing map:', error);
        mapElement.innerHTML = `
          <div class="map-placeholder">
            <div class="map-icon">MAP</div>
            <p>Map temporarily unavailable</p>
            <small>Lat: ${mappingData.coordinates.lat}, Lng: ${mappingData.coordinates.lng}</small>
          </div>
        `;
      }
    }
    
    // Initialize AI Features on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Add AI enhancement to existing search boxes
      document.querySelectorAll('input[placeholder*="search"], input[type="search"]').forEach(input => {
        input.classList.add('enhanced');
        input.addEventListener('input', () => enhanceSearch(input));
        input.addEventListener('blur', () => setTimeout(hideSearchSuggestions, 200));
      });
      
      // Initialize drag and drop for AI upload zones
      document.querySelectorAll('.ai-upload-zone').forEach(zone => {
        zone.addEventListener('dragover', (e) => {
          e.preventDefault();
          zone.classList.add('drag-over');
        });
        
        zone.addEventListener('dragleave', () => {
          zone.classList.remove('drag-over');
        });
        
        zone.addEventListener('drop', (e) => {
          e.preventDefault();
          zone.classList.remove('drag-over');
          
          const files = Array.from(e.dataTransfer.files);
          const container = zone.closest('.upload-section');
          
          if (files.length > 0) {
            handleAIFileUpload(files[0], container);
          }
        });
        
        zone.addEventListener('click', () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.pdf,.doc,.docx,.txt';
          input.onchange = (e) => {
            if (e.target.files.length > 0) {
              const container = zone.closest('.upload-section');
              handleAIFileUpload(e.target.files[0], container);
            }
          };
          input.click();
        });
      });
      
      console.log('AI features initialized successfully!');
    });
    
    function handleAIFileUpload(file, container) {
      // Show processing
      const uploadZone = container.querySelector('.ai-upload-zone');
      const processingElement = container.querySelector('.ai-processing');
      
      uploadZone.style.display = 'none';
      processingElement.style.display = 'block';
      
      // Process with AI
      processAIDocument(file, container);
    }
  </script>
</body>
</html>